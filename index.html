<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Legacy Forms</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* --- VARI√ÅVEIS E RESET --- */
:root {
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --secondary: #6366f1;
  --accent: #8b5cf6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --dark: #0f172a;
  --light: #f8fafc;
  --text-main: #1e293b;
  --text-muted: #64748b;
  
  --glass-bg: rgba(255, 255, 255, 0.65);
  --glass-border: 1px solid rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
  --blur: blur(16px);
  --radius: 24px;
}

* { box-sizing: border-box; outline: none; }

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: radial-gradient(circle at top left, #e0e7ff, #f8fafc, #f3e8ff);
  color: var(--text-main);
  height: 100vh;
  display: flex;
  overflow: hidden;
}

/* ==========================================================================
   TELA DE LOGIN (Importado do Legacy Cloud V6)
   ========================================================================== */
#supabase-login-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.login-card {
    background: white;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    width: 100%;
    max-width: 400px;
    text-align: center;
    animation: slideUpLogin 0.5s ease;
}

@keyframes slideUpLogin { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.login-logo {
    font-size: 3rem;
    color: var(--primary);
    margin-bottom: 10px;
}

.login-title { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
.login-subtitle { color: #64748b; font-size: 0.9rem; margin-bottom: 30px; }

.login-form-group { margin-bottom: 15px; text-align: left; }
.login-form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #475569; }
.login-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.3s; }
.login-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

.btn-login {
    width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px;
    font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px;
}
.btn-login:hover { background: var(--primary-dark); }
.btn-login:disabled { background: #94a3b8; cursor: not-allowed; }

.login-error {
    color: #ef4444; font-size: 0.85rem; margin-top: 15px; display: none; background: #fef2f2; padding: 10px; border-radius: 6px; border: 1px solid #fecaca;
}

/* Ocultar elementos do sistema enquanto n√£o logado */
body.not-authenticated aside,
body.not-authenticated main {
    display: none !important;
}

/* Ocultar login quando autenticado */
body.authenticated #supabase-login-overlay {
    display: none !important;
}

/* --- SIDEBAR --- */
aside {
  width: 280px;
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(20px);
  color: white;
  padding: 30px 20px;
  display: flex;
  flex-direction: column;
  box-shadow: 5px 0 30px rgba(0,0,0,0.1);
  z-index: 10;
}

aside .brand {
  font-size: 1.4rem;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 40px;
  padding-left: 10px;
  background: linear-gradient(to right, #60a5fa, #a78bfa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

aside nav button {
  width: 100%;
  background: transparent;
  border: none;
  color: #94a3b8;
  padding: 16px 20px;
  text-align: left;
  cursor: pointer;
  border-radius: 12px;
  font-weight: 500;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 5px;
}

aside nav button i { width: 20px; text-align: center; }

aside nav button:hover, aside nav button.active {
  background: rgba(255,255,255,0.1);
  color: white;
  transform: translateX(5px);
}

/* Estilo Especial para o Bot√£o do Drive */
.btn-drive-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}
.drive-icon {
    background: linear-gradient(135deg, #34A853, #4285F4, #FBBC04);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 1.1rem;
}
.edit-link-btn {
    opacity: 0.5;
    padding: 5px;
    border-radius: 4px;
    transition: 0.2s;
}
.edit-link-btn:hover {
    opacity: 1;
    background: rgba(255,255,255,0.2);
    color: white;
}

aside .user-profile {
  margin-top: auto;
  padding-top: 20px;
  border-top: 1px solid rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
aside .user-avatar {
  width: 40px; height: 40px; border-radius: 50%; background: var(--primary);
  display: flex; justify-content: center; align-items: center; font-weight: bold;
}

.btn-logout-sidebar {
    background: transparent;
    border: none;
    color: #fca5a5;
    cursor: pointer;
    font-size: 1.1rem;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s;
}
.btn-logout-sidebar:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

/* --- MAIN CONTENT --- */
main {
  flex: 1;
  padding: 40px;
  overflow-y: auto;
  position: relative;
}

header { margin-bottom: 40px; }
header h1 { font-size: 2rem; font-weight: 800; margin: 0 0 5px 0; color: var(--dark); letter-spacing: -1px; }
header p { color: var(--text-muted); margin: 0; font-size: 1rem; }

/* --- KPI CARDS --- */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 25px;
  margin-bottom: 40px;
}

.kpi-card {
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border: var(--glass-border);
  border-radius: var(--radius);
  padding: 25px;
  box-shadow: var(--glass-shadow);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  position: relative;
  overflow: hidden;
}

.kpi-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
.kpi-card::before {
  content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
  background: var(--primary);
}
.kpi-card.warning::before { background: var(--warning); }
.kpi-card.success::before { background: var(--success); }
.kpi-card.purple::before { background: var(--accent); }

.kpi-card h3 { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 10px 0; }
.kpi-card .value { font-size: 2.2rem; font-weight: 800; color: var(--dark); }
.kpi-card .icon { position: absolute; right: 20px; top: 25px; font-size: 2rem; opacity: 0.1; }

/* --- ACTION BAR & FORMS --- */
.action-area {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

.glass-panel {
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border: var(--glass-border);
  border-radius: var(--radius);
  padding: 30px;
  box-shadow: var(--glass-shadow);
  flex: 1;
  min-width: 300px;
}

.glass-panel h3 { margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }

.input-group { margin-bottom: 15px; position: relative; }
.input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
.form-control {
  width: 100%;
  padding: 12px 15px 12px 45px;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  background: rgba(255,255,255,0.8);
  transition: all 0.3s;
  font-size: 0.95rem;
}
.form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); background: white; }

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
.btn:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
.btn:active { transform: translateY(0); }

.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; width: 100%; justify-content: center; }
.btn-sm { padding: 8px 16px; font-size: 0.8rem; width: auto; }
.btn-success { background: var(--success); color: white; }
.btn-warning { background: var(--warning); color: white; }
.btn-zap { background: #25D366; color: white; }
.btn-outline { background: transparent; border: 1px solid var(--text-muted); color: var(--text-main); }

/* --- DATA TABLE MODERNIZADA --- */
.table-container {
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--glass-shadow);
  overflow: hidden;
  border: 1px solid rgba(0,0,0,0.05);
}

table { width: 100%; border-collapse: collapse; }
thead { background: #f1f5f9; }
th { text-align: left; padding: 18px 24px; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
td { padding: 18px 24px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: #f8fafc; }

/* Status Badges */
.badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.badge-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

/* Cores dos Status */
.st-created { background: #e0e7ff; color: #3730a3; }
.st-sent { background: #dbeafe; color: #1e40af; } /* Enviado Zap */
.st-answered { background: #dcfce7; color: #166534; } /* Cliente Respondeu */
.st-project { background: #f3e8ff; color: #6b21a8; } /* Em Projeto */
.st-approval { background: #ffedd5; color: #9a3412; } /* Aguardando Aprova√ß√£o */
.st-done { background: #10b981; color: #fff; }

/* Loading Overlay */
#loader {
  position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
  z-index: 999; display: flex; justify-content: center; align-items: center;
  transition: opacity 0.5s; opacity: 1; pointer-events: all;
}
#loader.hide { opacity: 0; pointer-events: none; }
.spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

</style>
</head>
<body class="not-authenticated">

<div id="supabase-login-overlay">
    <div class="login-card">
        <div class="login-logo"><i class="fa-solid fa-layer-group"></i></div>
        <h1 class="login-title">FormFlow 2.0</h1>
        <p class="login-subtitle">Gest√£o Inteligente</p>
        
        <div class="login-form-group">
            <label>Email de Acesso</label>
            <input type="email" id="login-email" class="login-input" placeholder="seu@email.com" onkeydown="if(event.key === 'Enter') document.getElementById('login-password').focus()">
        </div>
        
        <div class="login-form-group">
            <label>Senha</label>
            <input type="password" id="login-password" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key === 'Enter') authManager.login()">
        </div>

        <div class="login-error" id="login-error-msg"></div>

        <button class="btn-login" onclick="authManager.login()" id="btn-do-login">Entrar no Sistema</button>
        <p style="margin-top:20px; font-size:0.75rem; color:#94a3b8;">Sistema protegido e criptografado.</p>
    </div>
</div>

<div id="loader"><div class="spinner"></div></div>

<aside>
  <div class="brand">
    <i class="fa-solid fa-layer-group"></i> FormFlow 2.0
  </div> 
  <nav>
     <button class="active"><i class="fa-solid fa-house"></i> Painel Principal</button>
     
     <button onclick="DriveApp.open()" class="btn-drive-wrapper">
        <div style="display:flex; align-items:center; gap:12px">
            <i class="fa-brands fa-google-drive drive-icon"></i> 
            Google Drive
        </div>
        <div class="edit-link-btn" onclick="event.stopPropagation(); DriveApp.edit()" title="Alterar Link do Drive">
            <i class="fa-solid fa-pen" style="font-size: 0.8rem;"></i>
        </div>
     </button>
  </nav>

  <div class="user-profile">
    <div style="display:flex; align-items:center; gap:10px;">
        <div class="user-avatar">AD</div>
        <div>
          <div style="font-weight: 600; font-size: 0.9rem">Admin</div>
          <div style="font-size: 0.7rem; color: #94a3b8; display:flex; align-items:center; gap:4px">
            <span style="width:6px; height:6px; background:#10b981; border-radius:50%"></span> Online
          </div>
        </div>
    </div>
    <button class="btn-logout-sidebar" onclick="authManager.logout()" title="Sair do Sistema">
        <i class="fa-solid fa-sign-out-alt"></i>
    </button>
  </div>
</aside>

<main>
  <header>
    <h1>Gest√£o Inteligente de Formul√°rios</h1>
    <p>Sistema legado modernizado com IndexedDB Nativo</p>
  </header>

  <section class="cards-grid">
    <div class="kpi-card">
      <div class="icon"><i class="fa-solid fa-clock"></i></div>
      <h3>Aguardando Envio</h3>
      <div class="value" id="kpiPending">0</div>
    </div>
    <div class="kpi-card warning">
      <div class="icon"><i class="fa-solid fa-hourglass-half"></i></div>
      <h3>Resposta Pendente</h3>
      <div class="value" id="kpiSent">0</div>
    </div>
    <div class="kpi-card purple">
      <div class="icon"><i class="fa-solid fa-pen-ruler"></i></div>
      <h3>Em Projeto</h3>
      <div class="value" id="kpiProject">0</div>
    </div>
    <div class="kpi-card success">
      <div class="icon"><i class="fa-solid fa-check-circle"></i></div>
      <h3>Finalizados</h3>
      <div class="value" id="kpiDone">0</div>
    </div>
  </section>

  <div class="action-area">
    <div class="glass-panel">
      <h3><i class="fa-solid fa-user-plus" style="color:var(--primary)"></i> Novo Cliente</h3>
      <div class="input-group">
        <i class="fa-regular fa-user"></i>
        <input id="inName" class="form-control" placeholder="Nome do Cliente">
      </div>
      <div class="input-group">
        <i class="fa-brands fa-whatsapp"></i>
        <input id="inPhone" class="form-control" placeholder="WhatsApp (apenas n√∫meros)">
      </div>
      <button class="btn btn-primary" onclick="App.addClient()">
        <i class="fa-solid fa-save"></i> Salvar Cliente
      </button>
    </div>

    <div class="glass-panel">
      <h3><i class="fa-brands fa-google" style="color:var(--danger)"></i> Novo Fluxo de Formul√°rio</h3>
      <div class="input-group">
        <i class="fa-solid fa-users"></i>
        <select id="selClient" class="form-control">
          <option value="" disabled selected>Selecione o Cliente</option>
        </select>
      </div>
      <div class="input-group">
        <i class="fa-solid fa-link"></i>
        <input id="inLink" class="form-control" placeholder="Link do Google Forms">
      </div>
      <button class="btn btn-primary" onclick="App.addFormFlow()">
        <i class="fa-solid fa-play"></i> Iniciar Fluxo
      </button>
    </div>
  </div>

  <div class="table-container">
    <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin:0">Fluxos Ativos</h3>
      <div style="font-size:0.8rem; color:var(--text-muted)"><i class="fa-solid fa-sync fa-spin"></i> Banco de Dados Local</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Formul√°rio</th>
          <th>Status Atual</th>
          <th>Pr√≥xima A√ß√£o (Automa√ß√£o)</th>
          <th>Op√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        </tbody>
    </table>
  </div>
</main>


<script>
const SUPABASE_URL='https://rjyxkouegrropsarrhje.supabase.co',SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeXhrb3VlZ3Jyb3BzYXJyaGplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjYxNjcsImV4cCI6MjA4NTE0MjE2N30.UjNPnVBVhQcUSirXeWZ3RmYmAhDMqqbbVUChG_Mv57U';window['supabaseClient']=supabase['createClient'](SUPABASE_URL,SUPABASE_KEY);const authManager={'init':async()=>{const {data:{session:I}}=await supabaseClient['auth']['getSession']();authManager['updateUI'](I),supabaseClient['auth']['onAuthStateChange']((d,e)=>{authManager['updateUI'](e);});},'updateUI':I=>{const d=document['body'];I?(d['classList']['remove']('not-authenticated'),d['classList']['add']('authenticated'),typeof App!=='undefined'&&App['init']()):(d['classList']['remove']('authenticated'),d['classList']['add']('not-authenticated'));},'login':async()=>{const I=document['getElementById']('login-email')['value'],d=document['getElementById']('login-password')['value'],e=document['getElementById']('login-error-msg'),M=document['getElementById']('btn-do-login');if(!I||!d){authManager['showError']('Preencha\x20email\x20e\x20senha.');return;}M['innerText']='Autenticando...',M['disabled']=!![],e['style']['display']='none';const {data:L,error:b}=await supabaseClient['auth']['signInWithPassword']({'email':I,'password':d});M['innerText']='Entrar\x20no\x20Sistema',M['disabled']=![],b&&authManager['showError']('Erro:\x20'+b['message']);},'logout':async()=>{confirm('Deseja\x20sair\x20do\x20sistema?')&&await supabaseClient['auth']['signOut']();},'showError':I=>{const d=document['getElementById']('login-error-msg');d['innerText']=I,d['style']['display']='block';}};authManager['init']();const DBService={'dbName':'lg_crmDB','stores':{'CLIENTS':'clientsform','FLOWS':'flowsform'},'open':function(){return new Promise((I,d)=>{const e=indexedDB['open'](this['dbName']);e['onsuccess']=M=>{const L=M['target']['result'],b=Array['from'](L['objectStoreNames']),v=!b['includes'](this['stores']['CLIENTS'])||!b['includes'](this['stores']['FLOWS']);if(v){const B=L['version']+0x1;L['close'](),this['_openWithUpgrade'](B,I,d);}else I(L);},e['onupgradeneeded']=M=>this['_handleUpgrade'](M),e['onerror']=M=>d(M);});},'_openWithUpgrade':function(I,d,e){const M=indexedDB['open'](this['dbName'],I);M['onupgradeneeded']=L=>this['_handleUpgrade'](L),M['onsuccess']=L=>d(L['target']['result']),M['onerror']=L=>e(L);},'_handleUpgrade':function(I){const d=I['target']['result'];!d['objectStoreNames']['contains'](this['stores']['CLIENTS'])&&d['createObjectStore'](this['stores']['CLIENTS'],{'keyPath':'id'}),!d['objectStoreNames']['contains'](this['stores']['FLOWS'])&&d['createObjectStore'](this['stores']['FLOWS'],{'keyPath':'id'});},'getAll':async function(I){const d=await this['open']();return new Promise((e,M)=>{const L=d['transaction'](I,'readonly'),b=L['objectStore'](I),v=b['getAll']();v['onsuccess']=()=>e(v['result']),v['onerror']=()=>M(v['error']);});},'put':async function(I,d){const e=await this['open']();return new Promise((M,L)=>{const b=e['transaction'](I,'readwrite'),v=b['objectStore'](I),B=v['put'](d);b['oncomplete']=()=>M(B['result']),b['onerror']=()=>L(b['error']);});},'delete':async function(I,d){const e=await this['open']();return new Promise((M,L)=>{const b=e['transaction'](I,'readwrite'),v=b['objectStore'](I),B=v['delete'](d);b['oncomplete']=()=>M(),b['onerror']=()=>L(b['error']);});}},DriveApp={'key':'ff_drive_link','open':()=>{const I=localStorage['getItem'](DriveApp['key']);!I?DriveApp['edit']():window['open'](I,'_blank');},'edit':async()=>{const I=localStorage['getItem'](DriveApp['key'])||'',{value:d}=await Swal['fire']({'title':'Configurar\x20Google\x20Drive','input':'url','inputValue':I,'inputLabel':'Cole\x20o\x20link\x20da\x20pasta\x20ou\x20arquivo\x20do\x20Drive','inputPlaceholder':'https://drive.google.com/...','showCancelButton':!![],'confirmButtonText':'Salvar\x20Link','cancelButtonText':'Cancelar'});if(d){localStorage['setItem'](DriveApp['key'],d);const e=Swal['mixin']({'toast':!![],'position':'top-end','showConfirmButton':![],'timer':0xbb8});e['fire']({'icon':'success','title':'Link\x20do\x20Drive\x20atualizado!'});}}},App={'data':{'clients':[],'forms':[]},'statusMap':{'CRIADO':{'label':'Aguardando\x20Envio','class':'st-created','icon':'fa-regular\x20fa-paper-plane'},'ENVIADO':{'label':'Aguardando\x20Resposta','class':'st-sent','icon':'fa-solid\x20fa-hourglass-start'},'RESPONDIDO':{'label':'Em\x20Projeto','class':'st-project','icon':'fa-solid\x20fa-layer-group'},'APROVACAO':{'label':'Aguardando\x20Aprova√ß√£o','class':'st-approval','icon':'fa-solid\x20fa-magnifying-glass'},'FINALIZADO':{'label':'Aprovado\x20&\x20Finalizado','class':'st-done','icon':'fa-solid\x20fa-check-double'}},async 'init'(){await this['refreshData'](),this['render'](),setTimeout(()=>{document['getElementById']('loader')['classList']['add']('hide');},0x1f4);},async 'refreshData'(){try{this['data']['clients']=await DBService['getAll'](DBService['stores']['CLIENTS']),this['data']['forms']=await DBService['getAll'](DBService['stores']['FLOWS']);}catch(I){console['error']('Erro\x20ao\x20carregar\x20dados\x20do\x20IDB:',I);}},async 'addClient'(){const I=document['getElementById']('inName')['value']['trim']();let d=document['getElementById']('inPhone')['value']['replace'](/\D/g,'');if(!I||d['length']<0xa)return Swal['fire']('Aten√ß√£o','Preencha\x20nome\x20e\x20um\x20WhatsApp\x20v√°lido\x20(com\x20DDD).','warning');if(!d['startsWith']('55'))d='55'+d;const e={'id':Date['now'](),'name':I,'phone':d};await DBService['put'](DBService['stores']['CLIENTS'],e),document['getElementById']('inName')['value']='',document['getElementById']('inPhone')['value']='',await this['refreshData'](),this['render'](),this['toast']('Cliente\x20cadastrado\x20com\x20sucesso!');},async 'addFormFlow'(){const I=document['getElementById']('selClient')['value'],d=document['getElementById']('inLink')['value']['trim']();if(!I||!d)return Swal['fire']('Campos\x20vazios','Selecione\x20um\x20cliente\x20e\x20cole\x20o\x20link\x20do\x20Google\x20Forms.','warning');const e=this['data']['clients']['find'](L=>L['id']==I);if(!e)return Swal['fire']('Erro','Cliente\x20n√£o\x20encontrado.','error');const M={'id':Date['now'](),'clientId':e['id'],'clientName':e['name'],'clientPhone':e['phone'],'link':d,'status':'CRIADO','updated':Date['now']()};await DBService['put'](DBService['stores']['FLOWS'],M),document['getElementById']('inLink')['value']='',await this['refreshData'](),this['render'](),this['toast']('Novo\x20fluxo\x20iniciado!');},async 'updateStatus'(I,d,e=null){const M=this['data']['forms']['find'](L=>L['id']===I);if(!M)return;M['status']=d,M['updated']=Date['now'](),await DBService['put'](DBService['stores']['FLOWS'],M);if(e)e(M);await this['refreshData'](),this['render']();},'actionSend'(I){const d=this['data']['forms']['find'](M=>M['id']===I),e='Ol√°\x20'+d['clientName']+'!\x20Aqui\x20est√°\x20o\x20link\x20para\x20o\x20formul√°rio\x20que\x20precisamos\x20que\x20preencha:\x20'+d['link'];this['openWhats'](d['clientPhone'],e),this['updateStatus'](I,'ENVIADO');},'actionCheck'(I){Swal['fire']({'title':'Cliente\x20respondeu?','text':'Isso\x20mover√°\x20o\x20status\x20para\x20\x22Em\x20Projeto\x22.','icon':'question','showCancelButton':!![],'confirmButtonText':'Sim,\x20iniciar\x20projeto','cancelButtonText':'Ainda\x20n√£o'})['then'](d=>{d['isConfirmed']&&this['updateStatus'](I,'RESPONDIDO',()=>this['toast']('Status\x20atualizado\x20para\x20Em\x20Projeto'));});},'actionSendApproval'(I){const d=this['data']['forms']['find'](e=>e['id']===I);Swal['fire']({'title':'Projeto\x20conclu√≠do?','text':'Enviar\x20mensagem\x20de\x20aprova√ß√£o\x20para\x20o\x20cliente?','icon':'info','showCancelButton':!![],'confirmButtonText':'Enviar\x20Zap\x20e\x20Atualizar'})['then'](e=>{if(e['isConfirmed']){const M='Ol√°\x20'+d['clientName']+'!\x20Seu\x20projeto\x20est√°\x20pronto\x20para\x20an√°lise.\x20Aguardo\x20seu\x20OK\x20para\x20finalizar.';this['openWhats'](d['clientPhone'],M),this['updateStatus'](I,'APROVACAO');}});},'actionApprove'(I){Swal['fire']({'title':'Aprovar\x20Projeto?','text':'O\x20fluxo\x20ser√°\x20encerrado\x20como\x20Sucesso.','icon':'success','showCancelButton':!![],'confirmButtonText':'Aprovar\x20Final'})['then'](d=>{d['isConfirmed']&&this['updateStatus'](I,'FINALIZADO',()=>this['toast']('Projeto\x20Finalizado\x20com\x20Sucesso!','success'));});},'deleteForm'(I){Swal['fire']({'title':'Tem\x20certeza?','text':'N√£o\x20ser√°\x20poss√≠vel\x20reverter!','icon':'warning','showCancelButton':!![],'confirmButtonColor':'#d33','confirmButtonText':'Sim,\x20excluir'})['then'](async d=>{d['isConfirmed']&&(await DBService['delete'](DBService['stores']['FLOWS'],I),await this['refreshData'](),this['render'](),this['toast']('Fluxo\x20exclu√≠do.'));});},'render'(){const I=document['getElementById']('selClient');I['innerHTML']='<option\x20value=\x22\x22\x20disabled\x20selected>Selecione\x20o\x20Cliente</option>'+this['data']['clients']['map'](L=>'<option\x20value=\x22'+L['id']+'\x22>'+L['name']+'</option>')['join']('');const d=document['getElementById']('tableBody');d['innerHTML']='';let e={'pending':0x0,'sent':0x0,'project':0x0,'done':0x0};const M=[...this['data']['forms']]['sort']((L,v)=>v['updated']-L['updated']);M['forEach'](L=>{if(L['status']==='CRIADO')e['pending']++;if(L['status']==='ENVIADO')e['sent']++;if(L['status']==='RESPONDIDO'||L['status']==='APROVACAO')e['project']++;if(L['status']==='FINALIZADO')e['done']++;const b=this['statusMap'][L['status']];let v='';switch(L['status']){case'CRIADO':v='<button\x20class=\x22btn\x20btn-sm\x20btn-zap\x22\x20onclick=\x22App.actionSend('+L['id']+')\x22><i\x20class=\x22fa-brands\x20fa-whatsapp\x22></i>\x20Enviar\x20Link</button>';break;case'ENVIADO':v='<button\x20class=\x22btn\x20btn-sm\x20btn-primary\x22\x20onclick=\x22App.actionCheck('+L['id']+')\x22><i\x20class=\x22fa-solid\x20fa-check\x22></i>\x20J√°\x20respondeu?</button>';break;case'RESPONDIDO':v='<button\x20class=\x22btn\x20btn-sm\x20btn-warning\x22\x20onclick=\x22App.actionSendApproval('+L['id']+')\x22><i\x20class=\x22fa-solid\x20fa-paper-plane\x22></i>\x20Enviar\x20p/\x20Aprova√ß√£o</button>';break;case'APROVACAO':v='<button\x20class=\x22btn\x20btn-sm\x20btn-success\x22\x20onclick=\x22App.actionApprove('+L['id']+')\x22><i\x20class=\x22fa-solid\x20fa-thumbs-up\x22></i>\x20Aprovar</button>';break;case'FINALIZADO':v='<span\x20style=\x22color:#10b981;\x20font-size:0.8rem\x22><i\x20class=\x22fa-solid\x20fa-check-circle\x22></i>\x20Conclu√≠do</span>';break;}const B='<tr\x20class=\x22animate__animated\x20animate__fadeIn\x22><td><div\x20style=\x22font-weight:600\x22>'+L['clientName']+'</div><div\x20style=\x22font-size:0.75rem;\x20color:#64748b\x22>'+L['clientPhone']+'</div></td><td><a\x20href=\x22'+L['link']+'\x22\x20target=\x22_blank\x22\x20style=\x22color:var(--primary);\x20text-decoration:none;\x20font-weight:500\x22><i\x20class=\x22fa-solid\x20fa-external-link-alt\x22></i>\x20Abrir\x20Forms</a></td><td><span\x20class=\x22badge\x20'+b['class']+'\x22><div\x20class=\x22badge-dot\x22></div>\x20'+b['label']+'</span></td><td>'+v+'</td><td><button\x20class=\x22btn\x20btn-sm\x20btn-outline\x22\x20style=\x22color:var(--danger)\x22\x20onclick=\x22App.deleteForm('+L['id']+')\x22\x20title=\x22Excluir\x22><i\x20class=\x22fa-solid\x20fa-trash\x22></i></button></td></tr>';d['innerHTML']+=B;}),this['animateValue']('kpiPending',e['pending']),this['animateValue']('kpiSent',e['sent']),this['animateValue']('kpiProject',e['project']),this['animateValue']('kpiDone',e['done']);},'openWhats'(I,d){window['open']('https://wa.me/'+I+'?text='+encodeURIComponent(d),'_blank');},'toast'(I,d='success'){const e=Swal['mixin']({'toast':!![],'position':'top-end','showConfirmButton':![],'timer':0xbb8,'timerProgressBar':!![],'didOpen':M=>{M['onmouseenter']=Swal['stopTimer'],M['onmouseleave']=Swal['resumeTimer'];}});e['fire']({'icon':d,'title':I});},'animateValue'(I,d){const e=document['getElementById'](I);if(e)e['textContent']=d;}};(function(){const I='lg_crm_supadb',d='lg_crmDB';let e=sessionStorage['getItem']('sync_device_id');!e&&(e=crypto['randomUUID'](),sessionStorage['setItem']('sync_device_id',e));const M=e;let L=![],b=null;const v=new Map(),B=()=>window['supabaseClient']||window['supabase'],T=()=>new Promise(G=>{const Q=()=>B()?G(B()):setTimeout(Q,0x64);Q();});async function N(){const G=await T(),{data:Q}=await G['auth']['getSession']();return Q?.['session']?.['user']?.['id']||null;}function z(G){if(G===null||G===undefined)return'null';return JSON['stringify'](G);}const P={'put':IDBObjectStore['prototype']['put'],'add':IDBObjectStore['prototype']['add'],'delete':IDBObjectStore['prototype']['delete']};async function U(G,Q,R,l){if(L)return;const x=B(),a=await N();if(!x||!a)return;const y=G+'-'+R;Q==='delete'?v['delete'](y):v['set'](y,z(l)),x['from'](I)['upsert']({'user_id':a,'db_name':d,'store_name':G,'record_key':String(R),'record_value':Q==='delete'?null:l,'is_deleted':Q==='delete','device_id':M,'updated_at':new Date()['toISOString']()},{'onConflict':'user_id,db_name,store_name,record_key'})['then'](({error:Z})=>{if(Z)console['warn']('‚ö†Ô∏è\x20Sync\x20Upload\x20Falhou:',Z['message']);});}IDBObjectStore['prototype']['put']=function(G,Q){const R=P['put']['apply'](this,arguments),l=this['name'];return R['onsuccess']=x=>U(l,'put',Q||x['target']['result'],G),R;},IDBObjectStore['prototype']['add']=function(G,Q){const R=P['add']['apply'](this,arguments),l=this['name'];return R['onsuccess']=x=>U(l,'add',Q||x['target']['result'],G),R;},IDBObjectStore['prototype']['delete']=function(G){const Q=P['delete']['apply'](this,arguments),R=this['name'];return Q['onsuccess']=l=>U(R,'delete',G,null),Q;},console['log']('\x20.)');async function k(){const G=await N(),Q=B();if(!G||!Q)return;const R=indexedDB['open'](d);R['onsuccess']=l=>{const x=l['target']['result'],a=Array['from'](x['objectStoreNames']);a['forEach'](y=>{const Z=x['transaction']([y],'readonly'),D=Z['objectStore'](y);Promise['all']([new Promise(h=>D['getAll']()['onsuccess']=m=>h(m['target']['result'])),new Promise(h=>D['getAllKeys']()['onsuccess']=m=>h(m['target']['result']))])['then'](async([h,m])=>{if(!h['length'])return;const o=[];h['forEach']((s,j)=>{const A=String(m[j]),r=y+'-'+A,p=z(s);v['get'](r)!==p&&(o['push']({'user_id':G,'db_name':d,'store_name':y,'record_key':A,'record_value':s,'is_deleted':![],'device_id':M,'updated_at':new Date()['toISOString']()}),v['set'](r,p));}),o['length']>0x0&&(console['log']('.:\x20'+o['length']+'\x20itens'),await Q['from'](I)['upsert'](o,{'onConflict':'user_id,db_name,store_name,record_key'}));});});};}async function W(){const G=await N(),Q=B();if(!G||!Q)return;const {data:R,error:l}=await Q['from'](I)['select']('*')['eq']('user_id',G)['eq']('db_name',d);if(l||!R||!R['length'])return;const x=indexedDB['open'](d);x['onsuccess']=a=>{const y=a['target']['result'],Z=Array['from'](y['objectStoreNames']),D=R['filter'](o=>Z['includes'](o['store_name']));if(!D['length'])return;const h=y['transaction']([...new Set(D['map'](o=>o['store_name']))],'readwrite');L=!![];let m=0x0;D['forEach'](o=>{if(o['device_id']===M)return;const s=h['objectStore'](o['store_name']),j=!isNaN(o['record_key'])?Number(o['record_key']):o['record_key'],A=o['store_name']+'-'+o['record_key'];if(o['is_deleted']){s['delete'](j);v['has'](A)&&(v['delete'](A),m++);return;}const p=z(o['record_value']),H=v['get'](A);if(p===H)return;const K=o['record_value'];if(s['keyPath']&&K&&typeof K==='object'){if(!K[s['keyPath']])K[s['keyPath']]=j;s['put'](K);}else s['put'](K,j);v['set'](A,p),m++;}),h['oncomplete']=()=>{L=![];if(m>0x0)console['log']('üì•\x20Download\x20Sync:\x20'+m+'\x20altera√ß√µes\x20aplicadas.');},h['onerror']=()=>L=![];};}async function V(){const G=await N();if(!G)return;console['log']('.\x20',G);const Q=B();Q['channel']('global-sync-live')['on']('postgres_changes',{'event':'*','schema':'public','table':I,'filter':'user_id=eq.'+G},R=>{R['new']&&R['new']['device_id']!==M&&W();})['subscribe'](),await k(),setTimeout(W,0x1f4);if(b)clearInterval(b);b=setInterval(async()=>{await k(),await W();},0x2710);}T()['then'](G=>{G['auth']['onAuthStateChange']((Q,R)=>{if(Q==='SIGNED_IN'&&R)V();}),N()['then'](Q=>{if(Q)V();});});}());
</script>
</body>
</html>
