<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FormFlow ¬∑ Enterprise 2.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* --- VARI√ÅVEIS E RESET --- */
:root {
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --secondary: #6366f1;
  --accent: #8b5cf6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --dark: #0f172a;
  --light: #f8fafc;
  --text-main: #1e293b;
  --text-muted: #64748b;
  
  --glass-bg: rgba(255, 255, 255, 0.65);
  --glass-border: 1px solid rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
  --blur: blur(16px);
  --radius: 24px;
}

* { box-sizing: border-box; outline: none; }

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: radial-gradient(circle at top left, #e0e7ff, #f8fafc, #f3e8ff);
  color: var(--text-main);
  height: 100vh;
  display: flex;
  overflow: hidden;
}

/* ==========================================================================
   TELA DE LOGIN (Importado do Legacy Cloud V6)
   ========================================================================== */
#supabase-login-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.login-card {
    background: white;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    width: 100%;
    max-width: 400px;
    text-align: center;
    animation: slideUpLogin 0.5s ease;
}

@keyframes slideUpLogin { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.login-logo {
    font-size: 3rem;
    color: var(--primary);
    margin-bottom: 10px;
}

.login-title { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
.login-subtitle { color: #64748b; font-size: 0.9rem; margin-bottom: 30px; }

.login-form-group { margin-bottom: 15px; text-align: left; }
.login-form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #475569; }
.login-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.3s; }
.login-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

.btn-login {
    width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px;
    font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px;
}
.btn-login:hover { background: var(--primary-dark); }
.btn-login:disabled { background: #94a3b8; cursor: not-allowed; }

.login-error {
    color: #ef4444; font-size: 0.85rem; margin-top: 15px; display: none; background: #fef2f2; padding: 10px; border-radius: 6px; border: 1px solid #fecaca;
}

/* Ocultar elementos do sistema enquanto n√£o logado */
body.not-authenticated aside,
body.not-authenticated main {
    display: none !important;
}

/* Ocultar login quando autenticado */
body.authenticated #supabase-login-overlay {
    display: none !important;
}

/* --- SIDEBAR --- */
aside {
  width: 280px;
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(20px);
  color: white;
  padding: 30px 20px;
  display: flex;
  flex-direction: column;
  box-shadow: 5px 0 30px rgba(0,0,0,0.1);
  z-index: 10;
}

aside .brand {
  font-size: 1.4rem;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 40px;
  padding-left: 10px;
  background: linear-gradient(to right, #60a5fa, #a78bfa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

aside nav button {
  width: 100%;
  background: transparent;
  border: none;
  color: #94a3b8;
  padding: 16px 20px;
  text-align: left;
  cursor: pointer;
  border-radius: 12px;
  font-weight: 500;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 5px;
}

aside nav button i { width: 20px; text-align: center; }

aside nav button:hover, aside nav button.active {
  background: rgba(255,255,255,0.1);
  color: white;
  transform: translateX(5px);
}

/* Estilo Especial para o Bot√£o do Drive */
.btn-drive-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}
.drive-icon {
    background: linear-gradient(135deg, #34A853, #4285F4, #FBBC04);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 1.1rem;
}
.edit-link-btn {
    opacity: 0.5;
    padding: 5px;
    border-radius: 4px;
    transition: 0.2s;
}
.edit-link-btn:hover {
    opacity: 1;
    background: rgba(255,255,255,0.2);
    color: white;
}

aside .user-profile {
  margin-top: auto;
  padding-top: 20px;
  border-top: 1px solid rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
aside .user-avatar {
  width: 40px; height: 40px; border-radius: 50%; background: var(--primary);
  display: flex; justify-content: center; align-items: center; font-weight: bold;
}

.btn-logout-sidebar {
    background: transparent;
    border: none;
    color: #fca5a5;
    cursor: pointer;
    font-size: 1.1rem;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s;
}
.btn-logout-sidebar:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

/* --- MAIN CONTENT --- */
main {
  flex: 1;
  padding: 40px;
  overflow-y: auto;
  position: relative;
}

header { margin-bottom: 40px; }
header h1 { font-size: 2rem; font-weight: 800; margin: 0 0 5px 0; color: var(--dark); letter-spacing: -1px; }
header p { color: var(--text-muted); margin: 0; font-size: 1rem; }

/* --- KPI CARDS --- */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 25px;
  margin-bottom: 40px;
}

.kpi-card {
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border: var(--glass-border);
  border-radius: var(--radius);
  padding: 25px;
  box-shadow: var(--glass-shadow);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  position: relative;
  overflow: hidden;
}

.kpi-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
.kpi-card::before {
  content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
  background: var(--primary);
}
.kpi-card.warning::before { background: var(--warning); }
.kpi-card.success::before { background: var(--success); }
.kpi-card.purple::before { background: var(--accent); }

.kpi-card h3 { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 10px 0; }
.kpi-card .value { font-size: 2.2rem; font-weight: 800; color: var(--dark); }
.kpi-card .icon { position: absolute; right: 20px; top: 25px; font-size: 2rem; opacity: 0.1; }

/* --- ACTION BAR & FORMS --- */
.action-area {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

.glass-panel {
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border: var(--glass-border);
  border-radius: var(--radius);
  padding: 30px;
  box-shadow: var(--glass-shadow);
  flex: 1;
  min-width: 300px;
}

.glass-panel h3 { margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }

.input-group { margin-bottom: 15px; position: relative; }
.input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
.form-control {
  width: 100%;
  padding: 12px 15px 12px 45px;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  background: rgba(255,255,255,0.8);
  transition: all 0.3s;
  font-size: 0.95rem;
}
.form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); background: white; }

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
.btn:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
.btn:active { transform: translateY(0); }

.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; width: 100%; justify-content: center; }
.btn-sm { padding: 8px 16px; font-size: 0.8rem; width: auto; }
.btn-success { background: var(--success); color: white; }
.btn-warning { background: var(--warning); color: white; }
.btn-zap { background: #25D366; color: white; }
.btn-outline { background: transparent; border: 1px solid var(--text-muted); color: var(--text-main); }

/* --- DATA TABLE MODERNIZADA --- */
.table-container {
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--glass-shadow);
  overflow: hidden;
  border: 1px solid rgba(0,0,0,0.05);
}

table { width: 100%; border-collapse: collapse; }
thead { background: #f1f5f9; }
th { text-align: left; padding: 18px 24px; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
td { padding: 18px 24px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: #f8fafc; }

/* Status Badges */
.badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.badge-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

/* Cores dos Status */
.st-created { background: #e0e7ff; color: #3730a3; }
.st-sent { background: #dbeafe; color: #1e40af; } /* Enviado Zap */
.st-answered { background: #dcfce7; color: #166534; } /* Cliente Respondeu */
.st-project { background: #f3e8ff; color: #6b21a8; } /* Em Projeto */
.st-approval { background: #ffedd5; color: #9a3412; } /* Aguardando Aprova√ß√£o */
.st-done { background: #10b981; color: #fff; }

/* Loading Overlay */
#loader {
  position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
  z-index: 999; display: flex; justify-content: center; align-items: center;
  transition: opacity 0.5s; opacity: 1; pointer-events: all;
}
#loader.hide { opacity: 0; pointer-events: none; }
.spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

</style>
</head>
<body class="not-authenticated">

<div id="supabase-login-overlay">
    <div class="login-card">
        <div class="login-logo"><i class="fa-solid fa-layer-group"></i></div>
        <h1 class="login-title">FormFlow 2.0</h1>
        <p class="login-subtitle">Gest√£o Inteligente</p>
        
        <div class="login-form-group">
            <label>Email de Acesso</label>
            <input type="email" id="login-email" class="login-input" placeholder="seu@email.com" onkeydown="if(event.key === 'Enter') document.getElementById('login-password').focus()">
        </div>
        
        <div class="login-form-group">
            <label>Senha</label>
            <input type="password" id="login-password" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key === 'Enter') authManager.login()">
        </div>

        <div class="login-error" id="login-error-msg"></div>

        <button class="btn-login" onclick="authManager.login()" id="btn-do-login">Entrar no Sistema</button>
        <p style="margin-top:20px; font-size:0.75rem; color:#94a3b8;">Sistema protegido e criptografado.</p>
    </div>
</div>

<div id="loader"><div class="spinner"></div></div>

<aside>
  <div class="brand">
    <i class="fa-solid fa-layer-group"></i> FormFlow 2.0
  </div> 
  <nav>
     <button class="active"><i class="fa-solid fa-house"></i> Painel Principal</button>
     
     <button onclick="DriveApp.open()" class="btn-drive-wrapper">
        <div style="display:flex; align-items:center; gap:12px">
            <i class="fa-brands fa-google-drive drive-icon"></i> 
            Google Drive
        </div>
        <div class="edit-link-btn" onclick="event.stopPropagation(); DriveApp.edit()" title="Alterar Link do Drive">
            <i class="fa-solid fa-pen" style="font-size: 0.8rem;"></i>
        </div>
     </button>
  </nav>

  <div class="user-profile">
    <div style="display:flex; align-items:center; gap:10px;">
        <div class="user-avatar">AD</div>
        <div>
          <div style="font-weight: 600; font-size: 0.9rem">Admin</div>
          <div style="font-size: 0.7rem; color: #94a3b8; display:flex; align-items:center; gap:4px">
            <span style="width:6px; height:6px; background:#10b981; border-radius:50%"></span> Online
          </div>
        </div>
    </div>
    <button class="btn-logout-sidebar" onclick="authManager.logout()" title="Sair do Sistema">
        <i class="fa-solid fa-sign-out-alt"></i>
    </button>
  </div>
</aside>

<main>
  <header>
    <h1>Gest√£o Inteligente de Formul√°rios</h1>
    <p>Sistema legado modernizado com IndexedDB Nativo</p>
  </header>

  <section class="cards-grid">
    <div class="kpi-card">
      <div class="icon"><i class="fa-solid fa-clock"></i></div>
      <h3>Aguardando Envio</h3>
      <div class="value" id="kpiPending">0</div>
    </div>
    <div class="kpi-card warning">
      <div class="icon"><i class="fa-solid fa-hourglass-half"></i></div>
      <h3>Resposta Pendente</h3>
      <div class="value" id="kpiSent">0</div>
    </div>
    <div class="kpi-card purple">
      <div class="icon"><i class="fa-solid fa-pen-ruler"></i></div>
      <h3>Em Projeto</h3>
      <div class="value" id="kpiProject">0</div>
    </div>
    <div class="kpi-card success">
      <div class="icon"><i class="fa-solid fa-check-circle"></i></div>
      <h3>Finalizados</h3>
      <div class="value" id="kpiDone">0</div>
    </div>
  </section>

  <div class="action-area">
    <div class="glass-panel">
      <h3><i class="fa-solid fa-user-plus" style="color:var(--primary)"></i> Novo Cliente</h3>
      <div class="input-group">
        <i class="fa-regular fa-user"></i>
        <input id="inName" class="form-control" placeholder="Nome do Cliente">
      </div>
      <div class="input-group">
        <i class="fa-brands fa-whatsapp"></i>
        <input id="inPhone" class="form-control" placeholder="WhatsApp (apenas n√∫meros)">
      </div>
      <button class="btn btn-primary" onclick="App.addClient()">
        <i class="fa-solid fa-save"></i> Salvar Cliente
      </button>
    </div>

    <div class="glass-panel">
      <h3><i class="fa-brands fa-google" style="color:var(--danger)"></i> Novo Fluxo de Formul√°rio</h3>
      <div class="input-group">
        <i class="fa-solid fa-users"></i>
        <select id="selClient" class="form-control">
          <option value="" disabled selected>Selecione o Cliente</option>
        </select>
      </div>
      <div class="input-group">
        <i class="fa-solid fa-link"></i>
        <input id="inLink" class="form-control" placeholder="Link do Google Forms">
      </div>
      <button class="btn btn-primary" onclick="App.addFormFlow()">
        <i class="fa-solid fa-play"></i> Iniciar Fluxo
      </button>
    </div>
  </div>

  <div class="table-container">
    <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin:0">Fluxos Ativos</h3>
      <div style="font-size:0.8rem; color:var(--text-muted)"><i class="fa-solid fa-sync fa-spin"></i> Banco de Dados Local</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Formul√°rio</th>
          <th>Status Atual</th>
          <th>Pr√≥xima A√ß√£o (Automa√ß√£o)</th>
          <th>Op√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        </tbody>
    </table>
  </div>
</main>


<script>
(function(){const I='lg_crm_supadb',d='lg_crmDB';let e=sessionStorage['getItem']('sync_device_id');!e&&(e=crypto['randomUUID'](),sessionStorage['setItem']('sync_device_id',e));const M=e;let L=![],b=null;const v=new Map(),B=()=>window['supabaseClient']||window['supabase'],T=()=>new Promise(G=>{const Q=()=>B()?G(B()):setTimeout(Q,0x64);Q();});async function N(){const G=await T(),{data:Q}=await G['auth']['getSession']();return Q?.['session']?.['user']?.['id']||null;}function z(G){if(G===null||G===undefined)return'null';return JSON['stringify'](G);}const P={'put':IDBObjectStore['prototype']['put'],'add':IDBObjectStore['prototype']['add'],'delete':IDBObjectStore['prototype']['delete']};async function U(G,Q,R,l){if(L)return;const x=B(),a=await N();if(!x||!a)return;const y=G+'-'+R;Q==='delete'?v['delete'](y):v['set'](y,z(l)),x['from'](I)['upsert']({'user_id':a,'db_name':d,'store_name':G,'record_key':String(R),'record_value':Q==='delete'?null:l,'is_deleted':Q==='delete','device_id':M,'updated_at':new Date()['toISOString']()},{'onConflict':'user_id,db_name,store_name,record_key'})['then'](({error:Z})=>{if(Z)console['warn']('‚ö†Ô∏è\x20Sync\x20Upload\x20Falhou:',Z['message']);});}IDBObjectStore['prototype']['put']=function(G,Q){const R=P['put']['apply'](this,arguments),l=this['name'];return R['onsuccess']=x=>U(l,'put',Q||x['target']['result'],G),R;},IDBObjectStore['prototype']['add']=function(G,Q){const R=P['add']['apply'](this,arguments),l=this['name'];return R['onsuccess']=x=>U(l,'add',Q||x['target']['result'],G),R;},IDBObjectStore['prototype']['delete']=function(G){const Q=P['delete']['apply'](this,arguments),R=this['name'];return Q['onsuccess']=l=>U(R,'delete',G,null),Q;},console['log']('\x20.)');async function k(){const G=await N(),Q=B();if(!G||!Q)return;const R=indexedDB['open'](d);R['onsuccess']=l=>{const x=l['target']['result'],a=Array['from'](x['objectStoreNames']);a['forEach'](y=>{const Z=x['transaction']([y],'readonly'),D=Z['objectStore'](y);Promise['all']([new Promise(h=>D['getAll']()['onsuccess']=m=>h(m['target']['result'])),new Promise(h=>D['getAllKeys']()['onsuccess']=m=>h(m['target']['result']))])['then'](async([h,m])=>{if(!h['length'])return;const o=[];h['forEach']((s,j)=>{const A=String(m[j]),r=y+'-'+A,p=z(s);v['get'](r)!==p&&(o['push']({'user_id':G,'db_name':d,'store_name':y,'record_key':A,'record_value':s,'is_deleted':![],'device_id':M,'updated_at':new Date()['toISOString']()}),v['set'](r,p));}),o['length']>0x0&&(console['log']('.:\x20'+o['length']+'\x20itens'),await Q['from'](I)['upsert'](o,{'onConflict':'user_id,db_name,store_name,record_key'}));});});};}async function W(){const G=await N(),Q=B();if(!G||!Q)return;const {data:R,error:l}=await Q['from'](I)['select']('*')['eq']('user_id',G)['eq']('db_name',d);if(l||!R||!R['length'])return;const x=indexedDB['open'](d);x['onsuccess']=a=>{const y=a['target']['result'],Z=Array['from'](y['objectStoreNames']),D=R['filter'](o=>Z['includes'](o['store_name']));if(!D['length'])return;const h=y['transaction']([...new Set(D['map'](o=>o['store_name']))],'readwrite');L=!![];let m=0x0;D['forEach'](o=>{if(o['device_id']===M)return;const s=h['objectStore'](o['store_name']),j=!isNaN(o['record_key'])?Number(o['record_key']):o['record_key'],A=o['store_name']+'-'+o['record_key'];if(o['is_deleted']){s['delete'](j);v['has'](A)&&(v['delete'](A),m++);return;}const p=z(o['record_value']),H=v['get'](A);if(p===H)return;const K=o['record_value'];if(s['keyPath']&&K&&typeof K==='object'){if(!K[s['keyPath']])K[s['keyPath']]=j;s['put'](K);}else s['put'](K,j);v['set'](A,p),m++;}),h['oncomplete']=()=>{L=![];if(m>0x0)console['log']('üì•\x20Download\x20Sync:\x20'+m+'\x20altera√ß√µes\x20aplicadas.');},h['onerror']=()=>L=![];};}async function V(){const G=await N();if(!G)return;console['log']('.\x20',G);const Q=B();Q['channel']('global-sync-live')['on']('postgres_changes',{'event':'*','schema':'public','table':I,'filter':'user_id=eq.'+G},R=>{R['new']&&R['new']['device_id']!==M&&W();})['subscribe'](),await k(),setTimeout(W,0x1f4);if(b)clearInterval(b);b=setInterval(async()=>{await k(),await W();},0x2710);}T()['then'](G=>{G['auth']['onAuthStateChange']((Q,R)=>{if(Q==='SIGNED_IN'&&R)V();}),N()['then'](Q=>{if(Q)V();});});}());
</script>
</body>
</html>
