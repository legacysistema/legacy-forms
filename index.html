<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FormFlow · Enterprise Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ==========================================================================
   VARIÁVEIS E RESET
   ========================================================================== */
:root {
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --secondary: #6366f1;
  --accent: #8b5cf6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #06b6d4;
  
  /* Dark Theme */
  --dark-bg: #0f172a;
  --dark-surface: #1e293b;
  --dark-border: #334155;
  --dark-text: #e2e8f0;
  --dark-muted: #94a3b8;
  
  /* Glass Morphism */
  --glass-bg: rgba(30, 41, 59, 0.8);
  --glass-border: 1px solid rgba(148, 163, 184, 0.2);
  --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  --blur: blur(20px);
  --radius: 16px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
  color: var(--dark-text);
  height: 100vh;
  display: flex;
  overflow: hidden;
  position: relative;
}

/* Background animated pattern */
body::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* ==========================================================================
   LOGIN SCREEN
   ========================================================================== */
#supabase-login-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.login-card {
    background: var(--glass-bg);
    backdrop-filter: var(--blur);
    border: var(--glass-border);
    padding: 50px;
    border-radius: 24px;
    box-shadow: var(--glass-shadow);
    width: 100%;
    max-width: 450px;
    text-align: center;
    animation: slideUpLogin 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideUpLogin { 
  from { transform: translateY(30px); opacity: 0; } 
  to { transform: translateY(0); opacity: 1; } 
}

.login-logo {
    font-size: 3.5rem;
    background: linear-gradient(135deg, #60a5fa, #a78bfa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 15px;
}

.login-title { 
  font-size: 1.8rem; 
  font-weight: 800; 
  color: var(--dark-text); 
  margin-bottom: 8px;
  letter-spacing: -0.5px;
}

.login-subtitle { 
  color: var(--dark-muted); 
  font-size: 0.95rem; 
  margin-bottom: 35px; 
}

.login-form-group { 
  margin-bottom: 18px; 
  text-align: left; 
}

.login-form-group label { 
  display: block; 
  margin-bottom: 8px; 
  font-weight: 600; 
  font-size: 0.9rem; 
  color: var(--dark-text);
}

.login-input { 
  width: 100%; 
  padding: 14px 16px; 
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 12px; 
  color: var(--dark-text);
  font-size: 0.95rem;
  outline: none; 
  transition: all 0.3s ease;
}

.login-input:focus { 
  border-color: var(--primary); 
  background: rgba(255, 255, 255, 0.08);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); 
}

.btn-login {
    width: 100%; 
    padding: 14px; 
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white; 
    border: none; 
    border-radius: 12px;
    font-weight: 700; 
    font-size: 1rem;
    cursor: pointer; 
    transition: all 0.3s ease; 
    margin-top: 15px;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.btn-login:hover { 
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.btn-login:disabled { 
  background: rgba(148, 163, 184, 0.3);
  cursor: not-allowed; 
  transform: none;
  box-shadow: none;
}

.login-error {
    color: #fca5a5; 
    font-size: 0.9rem; 
    margin-top: 18px; 
    display: none; 
    background: rgba(239, 68, 68, 0.1);
    padding: 12px; 
    border-radius: 8px; 
    border: 1px solid rgba(239, 68, 68, 0.3);
}

body.not-authenticated aside,
body.not-authenticated main {
    display: none !important;
}

body.authenticated #supabase-login-overlay {
    display: none !important;
}

/* ==========================================================================
   SIDEBAR
   ========================================================================== */
aside {
  width: 300px;
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border-right: var(--glass-border);
  color: var(--dark-text);
  padding: 35px 25px;
  display: flex;
  flex-direction: column;
  box-shadow: var(--glass-shadow);
  z-index: 10;
  position: relative;
}

aside .brand {
  font-size: 1.6rem;
  font-weight: 900;
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 45px;
  padding-left: 10px;
  background: linear-gradient(135deg, #60a5fa, #a78bfa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -1px;
}

aside nav button {
  width: 100%;
  background: transparent;
  border: none;
  color: var(--dark-muted);
  padding: 16px 20px;
  text-align: left;
  cursor: pointer;
  border-radius: 14px;
  font-weight: 500;
  font-size: 0.95rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 6px;
  position: relative;
}

aside nav button i { 
  width: 22px; 
  text-align: center; 
  font-size: 1.1rem;
}

aside nav button:hover {
  background: rgba(255, 255, 255, 0.08);
  color: var(--dark-text);
  transform: translateX(6px);
}

aside nav button.active {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));
  color: white;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
}

aside nav button.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 4px;
  height: 60%;
  background: linear-gradient(to bottom, var(--primary), var(--accent));
  border-radius: 0 4px 4px 0;
}

aside .user-profile {
  margin-top: auto;
  padding-top: 25px;
  border-top: 1px solid rgba(148, 163, 184, 0.2);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

aside .user-avatar {
  width: 45px; 
  height: 45px; 
  border-radius: 50%; 
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex; 
  justify-content: center; 
  align-items: center; 
  font-weight: 800;
  font-size: 1.1rem;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.user-info {
  flex: 1;
}

.user-info .name {
  font-weight: 600;
  font-size: 0.95rem;
  color: var(--dark-text);
}

.user-info .email {
  font-size: 0.8rem;
  color: var(--dark-muted);
}

.btn-logout-sidebar {
    background: transparent;
    border: none;
    color: #fca5a5;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 10px;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.btn-logout-sidebar:hover {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    transform: rotate(15deg);
}

/* ==========================================================================
   MAIN CONTENT
   ========================================================================== */
main {
  flex: 1;
  padding: 45px;
  overflow-y: auto;
  position: relative;
  z-index: 1;
}

header { 
  margin-bottom: 45px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header .header-left h1 { 
  font-size: 2.2rem; 
  font-weight: 900; 
  margin: 0 0 8px 0; 
  color: var(--dark-text); 
  letter-spacing: -1.5px; 
}

header .header-left p { 
  color: var(--dark-muted); 
  margin: 0; 
  font-size: 1.05rem; 
}

.header-actions {
  display: flex;
  gap: 12px;
}

.btn-primary, .btn-secondary {
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  color: var(--dark-text);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(148, 163, 184, 0.3);
}

/* ==========================================================================
   KPI CARDS
   ========================================================================== */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 25px;
  margin-bottom: 45px;
}

.kpi-card {
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border: var(--glass-border);
  border-radius: var(--radius);
  padding: 28px;
  box-shadow: var(--glass-shadow);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.kpi-card:hover { 
  transform: translateY(-5px); 
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5); 
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: linear-gradient(to right, var(--primary), var(--accent));
}

.kpi-card .icon {
  width: 55px;
  height: 55px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.6rem;
  margin-bottom: 18px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.kpi-card.blue .icon { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
.kpi-card.purple .icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
.kpi-card.green .icon { background: linear-gradient(135deg, #10b981, #059669); color: white; }
.kpi-card.orange .icon { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }

.kpi-card .label {
  font-size: 0.9rem;
  color: var(--dark-muted);
  margin-bottom: 8px;
  font-weight: 500;
}

.kpi-card .value {
  font-size: 2rem;
  font-weight: 800;
  color: var(--dark-text);
  letter-spacing: -1px;
}

/* ==========================================================================
   CONTENT SECTIONS
   ========================================================================== */
.content-section {
  display: none;
}

.content-section.active {
  display: block;
  animation: fadeInUp 0.4s ease;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.glass-panel {
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border: var(--glass-border);
  border-radius: var(--radius);
  padding: 35px;
  box-shadow: var(--glass-shadow);
  margin-bottom: 30px;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 1px solid rgba(148, 163, 184, 0.2);
}

.panel-header h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--dark-text);
  display: flex;
  align-items: center;
  gap: 12px;
}

/* ==========================================================================
   FORM BUILDER
   ========================================================================== */
.form-builder-container {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 30px;
}

.field-palette {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(148, 163, 184, 0.15);
  border-radius: 12px;
  padding: 20px;
}

.field-palette h3 {
  font-size: 1rem;
  font-weight: 600;
  color: var(--dark-text);
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.field-type {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 10px;
  padding: 12px 16px;
  margin-bottom: 10px;
  cursor: grab;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--dark-text);
}

.field-type:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--primary);
  transform: translateX(5px);
}

.field-type i {
  color: var(--primary);
  font-size: 1.1rem;
  width: 20px;
  text-align: center;
}

.form-canvas {
  background: rgba(255, 255, 255, 0.03);
  border: 2px dashed rgba(148, 163, 184, 0.3);
  border-radius: 12px;
  padding: 30px;
  min-height: 500px;
}

.form-canvas.dragover {
  border-color: var(--primary);
  background: rgba(59, 130, 246, 0.05);
}

.form-field {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  position: relative;
  transition: all 0.3s ease;
}

.form-field:hover {
  border-color: var(--primary);
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
}

.form-field-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.form-field-label {
  font-weight: 600;
  color: var(--dark-text);
  font-size: 0.95rem;
}

.form-field-actions {
  display: flex;
  gap: 8px;
}

.field-action-btn {
  background: transparent;
  border: none;
  color: var(--dark-muted);
  cursor: pointer;
  padding: 6px 10px;
  border-radius: 6px;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.field-action-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--dark-text);
}

.field-action-btn.delete:hover {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

.form-field input,
.form-field select,
.form-field textarea {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 8px;
  padding: 10px 14px;
  color: var(--dark-text);
  font-size: 0.9rem;
  outline: none;
  transition: all 0.3s ease;
}

.form-field input:focus,
.form-field select:focus,
.form-field textarea:focus {
  border-color: var(--primary);
  background: rgba(255, 255, 255, 0.08);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
}

.form-settings {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(148, 163, 184, 0.15);
  border-radius: 12px;
  padding: 25px;
  margin-bottom: 25px;
}

.form-settings h3 {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--dark-text);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.settings-group {
  margin-bottom: 20px;
}

.settings-group label {
  display: block;
  font-weight: 500;
  color: var(--dark-text);
  margin-bottom: 8px;
  font-size: 0.9rem;
}

.settings-group input,
.settings-group textarea {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 8px;
  padding: 10px 14px;
  color: var(--dark-text);
  font-size: 0.9rem;
  outline: none;
}

.settings-group input:focus,
.settings-group textarea:focus {
  border-color: var(--primary);
  background: rgba(255, 255, 255, 0.08);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
}

/* ==========================================================================
   FORMS LIST
   ========================================================================== */
.forms-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 25px;
}

.form-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 14px;
  padding: 25px;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.form-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: linear-gradient(to right, var(--primary), var(--accent));
}

.form-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  border-color: var(--primary);
}

.form-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.form-card-title {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--dark-text);
  margin-bottom: 5px;
}

.form-card-description {
  font-size: 0.85rem;
  color: var(--dark-muted);
  margin-bottom: 15px;
  line-height: 1.5;
}

.form-card-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 15px;
  border-top: 1px solid rgba(148, 163, 184, 0.15);
}

.form-card-date {
  font-size: 0.8rem;
  color: var(--dark-muted);
}

.form-card-responses {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
}

.form-card-actions {
  display: flex;
  gap: 8px;
  margin-top: 15px;
}

.btn-small {
  padding: 8px 14px;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn-small.edit {
  background: rgba(59, 130, 246, 0.15);
  color: var(--primary);
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.btn-small.link {
  background: rgba(139, 92, 246, 0.15);
  color: var(--accent);
  border: 1px solid rgba(139, 92, 246, 0.3);
}

.btn-small.delete {
  background: rgba(239, 68, 68, 0.15);
  color: var(--danger);
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.btn-small:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* ==========================================================================
   CLIENTS TABLE
   ========================================================================== */
.table-container {
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
}

.data-table thead {
  background: rgba(255, 255, 255, 0.05);
  border-bottom: 2px solid rgba(148, 163, 184, 0.2);
}

.data-table th {
  padding: 15px;
  text-align: left;
  font-weight: 600;
  color: var(--dark-text);
  font-size: 0.9rem;
}

.data-table tbody tr {
  border-bottom: 1px solid rgba(148, 163, 184, 0.1);
  transition: all 0.2s ease;
}

.data-table tbody tr:hover {
  background: rgba(255, 255, 255, 0.05);
}

.data-table td {
  padding: 15px;
  color: var(--dark-muted);
  font-size: 0.9rem;
}

.status-badge {
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  display: inline-block;
}

.status-badge.enviado {
  background: rgba(59, 130, 246, 0.2);
  color: #60a5fa;
}

.status-badge.recebido {
  background: rgba(245, 158, 11, 0.2);
  color: #fbbf24;
}

.status-badge.finalizado {
  background: rgba(16, 185, 129, 0.2);
  color: #34d399;
}

.table-actions {
  display: flex;
  gap: 8px;
}

.table-action-btn {
  background: transparent;
  border: none;
  color: var(--dark-muted);
  cursor: pointer;
  padding: 6px 10px;
  border-radius: 6px;
  transition: all 0.2s ease;
  font-size: 1rem;
}

.table-action-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--primary);
}

/* ==========================================================================
   MODAL
   ========================================================================== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(10px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal.active {
  display: flex;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--dark-surface);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 16px;
  padding: 35px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 20px;
  border-bottom: 1px solid rgba(148, 163, 184, 0.2);
}

.modal-header h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--dark-text);
}

.modal-close {
  background: transparent;
  border: none;
  color: var(--dark-muted);
  font-size: 1.5rem;
  cursor: pointer;
  width: 35px;
  height: 35px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.modal-close:hover {
  background: rgba(239, 68, 68, 0.15);
  color: var(--danger);
  transform: rotate(90deg);
}

.modal-body {
  margin-bottom: 25px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  font-weight: 500;
  color: var(--dark-text);
  margin-bottom: 8px;
  font-size: 0.9rem;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 8px;
  padding: 12px 14px;
  color: var(--dark-text);
  font-size: 0.95rem;
  outline: none;
  transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  border-color: var(--primary);
  background: rgba(255, 255, 255, 0.08);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
}

.modal-footer {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.btn-cancel {
  padding: 12px 24px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 10px;
  color: var(--dark-text);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-cancel:hover {
  background: rgba(255, 255, 255, 0.1);
}

.btn-save {
  padding: 12px 24px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border: none;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

/* ==========================================================================
   LINK SHARE MODAL
   ========================================================================== */
.link-container {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 10px;
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 15px;
}

.link-input {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--primary);
  font-size: 0.9rem;
  outline: none;
}

.btn-copy {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border: none;
  color: white;
  padding: 10px 18px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-copy:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
}

/* ==========================================================================
   RESPONSE VIEW
   ========================================================================== */
.response-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 12px;
  padding: 25px;
  margin-bottom: 20px;
}

.response-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(148, 163, 184, 0.15);
}

.response-meta {
  display: flex;
  gap: 20px;
  font-size: 0.85rem;
  color: var(--dark-muted);
}

.response-field {
  margin-bottom: 18px;
}

.response-label {
  font-weight: 600;
  color: var(--dark-text);
  margin-bottom: 6px;
  font-size: 0.9rem;
}

.response-value {
  color: var(--dark-muted);
  font-size: 0.95rem;
}

/* ==========================================================================
   SCROLLBAR CUSTOM
   ========================================================================== */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: rgba(148, 163, 184, 0.3);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(148, 163, 184, 0.5);
}

/* ==========================================================================
   EMPTY STATE
   ========================================================================== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
}

.empty-state i {
  font-size: 4rem;
  color: var(--dark-muted);
  margin-bottom: 20px;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--dark-text);
  margin-bottom: 10px;
}

.empty-state p {
  color: var(--dark-muted);
  font-size: 0.95rem;
}

/* ==========================================================================
   RESPONSIVE
   ========================================================================== */
@media (max-width: 768px) {
  body {
    flex-direction: column;
  }
  
  aside {
    width: 100%;
    padding: 20px;
  }
  
  main {
    padding: 25px;
  }
  
  .form-builder-container {
    grid-template-columns: 1fr;
  }
  
  .cards-grid {
    grid-template-columns: 1fr;
  }
  
  header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
}

/* ==========================================================================
   TOAST NOTIFICATIONS
   ========================================================================== */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border: var(--glass-border);
  border-radius: 12px;
  padding: 18px 24px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  z-index: 10000;
  display: flex;
  align-items: center;
  gap: 14px;
  animation: slideInRight 0.3s ease;
  min-width: 300px;
}

@keyframes slideInRight {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--danger); }
.toast.info { border-left: 4px solid var(--info); }

.toast i {
  font-size: 1.3rem;
}

.toast.success i { color: var(--success); }
.toast.error i { color: var(--danger); }
.toast.info i { color: var(--info); }

.toast-message {
  flex: 1;
  color: var(--dark-text);
  font-weight: 500;
}
</style>
</head>
<body class="not-authenticated">

<!-- ==========================================================================
     TELA DE LOGIN
     ========================================================================== -->
<div id="supabase-login-overlay">
  <div class="login-card">
    <div class="login-logo">
      <i class="fas fa-layer-group"></i>
    </div>
    <h2 class="login-title">FormFlow</h2>
    <p class="login-subtitle">Enterprise Premium · Sistema de Formulários</p>
    
    <form id="login-form">
      <div class="login-form-group">
        <label for="login-email">E-mail</label>
        <input type="email" id="login-email" class="login-input" placeholder="seu@email.com" required>
      </div>
      
      <div class="login-form-group">
        <label for="login-password">Senha</label>
        <input type="password" id="login-password" class="login-input" placeholder="••••••••" required>
      </div>
      
      <button type="submit" class="btn-login" id="btn-login">
        <span id="login-text">Entrar</span>
      </button>
      
      <div class="login-error" id="login-error"></div>
    </form>
  </div>
</div>

<!-- ==========================================================================
     SIDEBAR
     ========================================================================== -->
<aside>
  <div class="brand">
    <i class="fas fa-layer-group"></i>
    <span>FormFlow</span>
  </div>
  
  <nav>
    <button class="nav-btn active" data-section="dashboard">
      <i class="fas fa-chart-line"></i>
      Dashboard
    </button>
    <button class="nav-btn" data-section="forms">
      <i class="fas fa-file-lines"></i>
      Meus Formulários
    </button>
    <button class="nav-btn" data-section="create">
      <i class="fas fa-plus-circle"></i>
      Criar Formulário
    </button>
    <button class="nav-btn" data-section="responses">
      <i class="fas fa-inbox"></i>
      Respostas
    </button>
    <button class="nav-btn" data-section="clients">
      <i class="fas fa-users"></i>
      Clientes
    </button>
  </nav>
  
  <div class="user-profile">
    <div class="user-avatar" id="user-avatar">U</div>
    <div class="user-info">
      <div class="name" id="user-name">Usuário</div>
      <div class="email" id="user-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="502523352210353d31393c7e333f3d">[email&#160;protected]</a></div>
    </div>
    <button class="btn-logout-sidebar" id="btn-logout" title="Sair">
      <i class="fas fa-right-from-bracket"></i>
    </button>
  </div>
</aside>

<!-- ==========================================================================
     MAIN CONTENT
     ========================================================================== -->
<main>
  <!-- DASHBOARD -->
  <section id="section-dashboard" class="content-section active">
    <header>
      <div class="header-left">
        <h1>Dashboard</h1>
        <p>Visão geral do sistema de formulários</p>
      </div>
    </header>
    
    <div class="cards-grid">
      <div class="kpi-card blue">
        <div class="icon"><i class="fas fa-file-lines"></i></div>
        <div class="label">Total de Formulários</div>
        <div class="value" id="kpi-forms">0</div>
      </div>
      
      <div class="kpi-card purple">
        <div class="icon"><i class="fas fa-paper-plane"></i></div>
        <div class="label">Formulários Enviados</div>
        <div class="value" id="kpi-sent">0</div>
      </div>
      
      <div class="kpi-card green">
        <div class="icon"><i class="fas fa-check-circle"></i></div>
        <div class="label">Respostas Recebidas</div>
        <div class="value" id="kpi-received">0</div>
      </div>
      
      <div class="kpi-card orange">
        <div class="icon"><i class="fas fa-users"></i></div>
        <div class="label">Total de Clientes</div>
        <div class="value" id="kpi-clients">0</div>
      </div>
    </div>
    
    <div class="glass-panel">
      <div class="panel-header">
        <h2><i class="fas fa-chart-bar"></i> Atividade Recente</h2>
      </div>
      <div id="recent-activity">
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <h3>Nenhuma atividade recente</h3>
          <p>Crie seu primeiro formulário para começar</p>
        </div>
      </div>
    </div>
  </section>

  <!-- MEUS FORMULÁRIOS -->
  <section id="section-forms" class="content-section">
    <header>
      <div class="header-left">
        <h1>Meus Formulários</h1>
        <p>Gerencie todos os seus formulários</p>
      </div>
      <div class="header-actions">
        <button class="btn-primary" onclick="navigateTo('create')">
          <i class="fas fa-plus"></i> Novo Formulário
        </button>
      </div>
    </header>
    
    <div class="glass-panel">
      <div id="forms-list-container">
        <div class="empty-state">
          <i class="fas fa-file-lines"></i>
          <h3>Nenhum formulário criado</h3>
          <p>Clique em "Novo Formulário" para começar</p>
        </div>
      </div>
    </div>
  </section>

  <!-- CRIAR FORMULÁRIO -->
  <section id="section-create" class="content-section">
    <header>
      <div class="header-left">
        <h1 id="create-title">Criar Novo Formulário</h1>
        <p>Arraste os campos para o canvas para criar seu formulário</p>
      </div>
      <div class="header-actions">
        <button class="btn-secondary" onclick="navigateTo('forms')">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
        <button class="btn-primary" id="btn-save-form">
          <i class="fas fa-save"></i> Salvar Formulário
        </button>
      </div>
    </header>
    
    <div class="glass-panel">
      <div class="form-settings">
        <h3><i class="fas fa-cog"></i> Configurações do Formulário</h3>
        <div class="settings-group">
          <label>Título do Formulário</label>
          <input type="text" id="form-title" placeholder="Ex: Pesquisa de Satisfação" value="">
        </div>
        <div class="settings-group">
          <label>Descrição</label>
          <textarea id="form-description" rows="2" placeholder="Descreva o propósito deste formulário"></textarea>
        </div>
      </div>
      
      <div class="form-builder-container">
        <div class="field-palette">
          <h3><i class="fas fa-toolbox"></i> Campos Disponíveis</h3>
          <div class="field-type" draggable="true" data-type="text">
            <i class="fas fa-font"></i>
            <span>Texto Curto</span>
          </div>
          <div class="field-type" draggable="true" data-type="textarea">
            <i class="fas fa-align-left"></i>
            <span>Texto Longo</span>
          </div>
          <div class="field-type" draggable="true" data-type="email">
            <i class="fas fa-envelope"></i>
            <span>E-mail</span>
          </div>
          <div class="field-type" draggable="true" data-type="phone">
            <i class="fas fa-phone"></i>
            <span>Telefone</span>
          </div>
          <div class="field-type" draggable="true" data-type="number">
            <i class="fas fa-hashtag"></i>
            <span>Número</span>
          </div>
          <div class="field-type" draggable="true" data-type="date">
            <i class="fas fa-calendar"></i>
            <span>Data</span>
          </div>
          <div class="field-type" draggable="true" data-type="select">
            <i class="fas fa-list"></i>
            <span>Seleção</span>
          </div>
          <div class="field-type" draggable="true" data-type="radio">
            <i class="fas fa-circle-dot"></i>
            <span>Múltipla Escolha</span>
          </div>
          <div class="field-type" draggable="true" data-type="checkbox">
            <i class="fas fa-check-square"></i>
            <span>Caixas de Seleção</span>
          </div>
        </div>
        
        <div class="form-canvas" id="form-canvas">
          <div class="empty-state">
            <i class="fas fa-hand-pointer"></i>
            <h3>Arraste campos aqui</h3>
            <p>Comece a criar seu formulário arrastando campos da paleta</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- RESPOSTAS -->
  <section id="section-responses" class="content-section">
    <header>
      <div class="header-left">
        <h1>Respostas</h1>
        <p>Visualize todas as respostas recebidas</p>
      </div>
    </header>
    
    <div class="glass-panel">
      <div id="responses-container">
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <h3>Nenhuma resposta recebida</h3>
          <p>As respostas aparecerão aqui quando os formulários forem preenchidos</p>
        </div>
      </div>
    </div>
  </section>

  <!-- CLIENTES -->
  <section id="section-clients" class="content-section">
    <header>
      <div class="header-left">
        <h1>Clientes</h1>
        <p>Gerencie seu cadastro de clientes</p>
      </div>
      <div class="header-actions">
        <button class="btn-primary" onclick="openClientModal()">
          <i class="fas fa-user-plus"></i> Novo Cliente
        </button>
      </div>
    </header>
    
    <div class="glass-panel">
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>E-mail</th>
              <th>Telefone</th>
              <th>Empresa</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="clients-table-body">
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px;">
                <div class="empty-state">
                  <i class="fas fa-users"></i>
                  <h3>Nenhum cliente cadastrado</h3>
                  <p>Clique em "Novo Cliente" para adicionar</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- ==========================================================================
     MODAL - CLIENTE
     ========================================================================== -->
<div class="modal" id="client-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="client-modal-title">Novo Cliente</h2>
      <button class="modal-close" onclick="closeClientModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="client-form">
        <input type="hidden" id="client-id">
        <div class="form-group">
          <label>Nome Completo *</label>
          <input type="text" id="client-name" required>
        </div>
        <div class="form-group">
          <label>E-mail *</label>
          <input type="email" id="client-email" required>
        </div>
        <div class="form-group">
          <label>Telefone</label>
          <input type="tel" id="client-phone">
        </div>
        <div class="form-group">
          <label>Empresa</label>
          <input type="text" id="client-company">
        </div>
        <div class="form-group">
          <label>Cargo</label>
          <input type="text" id="client-position">
        </div>
        <div class="form-group">
          <label>Observações</label>
          <textarea id="client-notes" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeClientModal()">Cancelar</button>
      <button class="btn-save" onclick="saveClient()">Salvar Cliente</button>
    </div>
  </div>
</div>

<!-- ==========================================================================
     MODAL - COMPARTILHAR LINK
     ========================================================================== -->
<div class="modal" id="link-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Compartilhar Formulário</h2>
      <button class="modal-close" onclick="closeLinkModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p style="color: var(--dark-muted); margin-bottom: 15px;">
        Copie o link abaixo e compartilhe com seus clientes:
      </p>
      <div class="link-container">
        <input type="text" class="link-input" id="form-link" readonly>
        <button class="btn-copy" onclick="copyFormLink()">
          <i class="fas fa-copy"></i> Copiar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ==========================================================================
     MODAL - VISUALIZAR RESPOSTA
     ========================================================================== -->
<div class="modal" id="response-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Resposta do Formulário</h2>
      <button class="modal-close" onclick="closeResponseModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="response-modal-body">
      <!-- Conteúdo dinâmico -->
    </div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ==========================================================================
// SUPABASE CONFIGURATION
// ==========================================================================
const SUPABASE_URL = 'https://rjyxkouegrropsarrhje.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeXhrb3VlZ3Jyb3BzYXJyaGplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjYxNjcsImV4cCI6MjA4NTE0MjE2N30.UjNPnVBVhQcUSirXeWZ3RmYmAhDMqqbbVUChG_Mv57U';

let supabaseClient = null;

async function initSupabase() {
    if (supabaseClient) return supabaseClient;
    
    const { createClient } = supabase;
    supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Check auth state
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
        handleAuthSuccess(session.user);
    }
    
    return supabaseClient;
}

// ==========================================================================
// INDEXEDDB CONFIGURATION
// ==========================================================================
const DB_NAME = 'FormFlowDB';
const DB_VERSION = 1;

let db = null;

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
            const database = event.target.result;
            
            // Store: forms
            if (!database.objectStoreNames.contains('forms')) {
                const formsStore = database.createObjectStore('forms', { keyPath: 'id', autoIncrement: true });
                formsStore.createIndex('userId', 'userId', { unique: false });
                formsStore.createIndex('createdAt', 'createdAt', { unique: false });
            }
            
            // Store: clients
            if (!database.objectStoreNames.contains('clients')) {
                const clientsStore = database.createObjectStore('clients', { keyPath: 'id', autoIncrement: true });
                clientsStore.createIndex('userId', 'userId', { unique: false });
                clientsStore.createIndex('email', 'email', { unique: false });
            }
            
            // Store: responses
            if (!database.objectStoreNames.contains('responses')) {
                const responsesStore = database.createObjectStore('responses', { keyPath: 'id', autoIncrement: true });
                responsesStore.createIndex('userId', 'userId', { unique: false });
                responsesStore.createIndex('formId', 'formId', { unique: false });
                responsesStore.createIndex('status', 'status', { unique: false });
            }
            
            // Store: form_submissions (tracking)
            if (!database.objectStoreNames.contains('form_submissions')) {
                const submissionsStore = database.createObjectStore('form_submissions', { keyPath: 'id', autoIncrement: true });
                submissionsStore.createIndex('userId', 'userId', { unique: false });
                submissionsStore.createIndex('formId', 'formId', { unique: false });
                submissionsStore.createIndex('clientId', 'clientId', { unique: false });
                submissionsStore.createIndex('status', 'status', { unique: false });
            }
        };
    });
}

// Generic DB operations
async function addRecord(storeName, data) {
    const transaction = db.transaction([storeName], 'readwrite');
    const store = transaction.objectStore(storeName);
    return new Promise((resolve, reject) => {
        const request = store.add(data);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function updateRecord(storeName, data) {
    const transaction = db.transaction([storeName], 'readwrite');
    const store = transaction.objectStore(storeName);
    return new Promise((resolve, reject) => {
        const request = store.put(data);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function deleteRecord(storeName, id) {
    const transaction = db.transaction([storeName], 'readwrite');
    const store = transaction.objectStore(storeName);
    return new Promise((resolve, reject) => {
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

async function getAllRecords(storeName, indexName = null, indexValue = null) {
    const transaction = db.transaction([storeName], 'readonly');
    const store = transaction.objectStore(storeName);
    
    return new Promise((resolve, reject) => {
        let request;
        if (indexName && indexValue !== null) {
            const index = store.index(indexName);
            request = index.getAll(indexValue);
        } else {
            request = store.getAll();
        }
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function getRecordById(storeName, id) {
    const transaction = db.transaction([storeName], 'readonly');
    const store = transaction.objectStore(storeName);
    return new Promise((resolve, reject) => {
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// ==========================================================================
// AUTHENTICATION
// ==========================================================================
let currentUser = null;

document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const btnLogin = document.getElementById('btn-login');
    const loginText = document.getElementById('login-text');
    const errorDiv = document.getElementById('login-error');
    
    btnLogin.disabled = true;
    loginText.textContent = 'Entrando...';
    errorDiv.style.display = 'none';
    
    try {
        const client = await initSupabase();
        const { data, error } = await client.auth.signInWithPassword({ email, password });
        
        if (error) throw error;
        
        handleAuthSuccess(data.user);
    } catch (error) {
        errorDiv.textContent = error.message || 'Erro ao fazer login';
        errorDiv.style.display = 'block';
        btnLogin.disabled = false;
        loginText.textContent = 'Entrar';
    }
});

function handleAuthSuccess(user) {
    currentUser = user;
    document.body.classList.remove('not-authenticated');
    document.body.classList.add('authenticated');
    
    // Update user info
    document.getElementById('user-name').textContent = user.email.split('@')[0];
    document.getElementById('user-email').textContent = user.email;
    document.getElementById('user-avatar').textContent = user.email[0].toUpperCase();
    
    // Load data
    loadDashboard();
}

document.getElementById('btn-logout').addEventListener('click', async () => {
    const client = await initSupabase();
    await client.auth.signOut();
    location.reload();
});

// ==========================================================================
// NAVIGATION
// ==========================================================================
function navigateTo(section) {
    // Update nav buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.section === section) {
            btn.classList.add('active');
        }
    });
    
    // Update sections
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    document.getElementById(`section-${section}`).classList.add('active');
    
    // Load section data
    if (section === 'dashboard') loadDashboard();
    else if (section === 'forms') loadForms();
    else if (section === 'responses') loadResponses();
    else if (section === 'clients') loadClients();
    else if (section === 'create') resetFormBuilder();
}

document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        navigateTo(btn.dataset.section);
    });
});

// ==========================================================================
// DASHBOARD
// ==========================================================================
async function loadDashboard() {
    if (!currentUser) return;
    
    const forms = await getAllRecords('forms', 'userId', currentUser.id);
    const clients = await getAllRecords('clients', 'userId', currentUser.id);
    const responses = await getAllRecords('responses', 'userId', currentUser.id);
    const submissions = await getAllRecords('form_submissions', 'userId', currentUser.id);
    
    document.getElementById('kpi-forms').textContent = forms.length;
    document.getElementById('kpi-clients').textContent = clients.length;
    document.getElementById('kpi-received').textContent = responses.length;
    document.getElementById('kpi-sent').textContent = submissions.filter(s => s.status === 'enviado').length;
}

// ==========================================================================
// FORM BUILDER
// ==========================================================================
let currentFormFields = [];
let currentFormId = null;

// Drag and Drop
document.addEventListener('DOMContentLoaded', () => {
    const fieldTypes = document.querySelectorAll('.field-type');
    const canvas = document.getElementById('form-canvas');
    
    fieldTypes.forEach(field => {
        field.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('fieldType', e.target.dataset.type);
        });
    });
    
    canvas.addEventListener('dragover', (e) => {
        e.preventDefault();
        canvas.classList.add('dragover');
    });
    
    canvas.addEventListener('dragleave', () => {
        canvas.classList.remove('dragover');
    });
    
    canvas.addEventListener('drop', (e) => {
        e.preventDefault();
        canvas.classList.remove('dragover');
        
        const fieldType = e.dataTransfer.getData('fieldType');
        addFieldToCanvas(fieldType);
    });
});

function addFieldToCanvas(type) {
    const canvas = document.getElementById('form-canvas');
    
    // Remove empty state if exists
    const emptyState = canvas.querySelector('.empty-state');
    if (emptyState) emptyState.remove();
    
    const fieldId = `field-${Date.now()}`;
    const field = {
        id: fieldId,
        type: type,
        label: getFieldLabel(type),
        required: false,
        options: type === 'select' || type === 'radio' || type === 'checkbox' ? ['Opção 1', 'Opção 2'] : null
    };
    
    currentFormFields.push(field);
    renderField(field);
}

function getFieldLabel(type) {
    const labels = {
        text: 'Campo de Texto',
        textarea: 'Texto Longo',
        email: 'Endereço de E-mail',
        phone: 'Número de Telefone',
        number: 'Número',
        date: 'Data',
        select: 'Seleção',
        radio: 'Múltipla Escolha',
        checkbox: 'Caixas de Seleção'
    };
    return labels[type] || 'Campo';
}

function renderField(field) {
    const canvas = document.getElementById('form-canvas');
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'form-field';
    fieldDiv.dataset.fieldId = field.id;
    
    let inputHTML = '';
    
    switch(field.type) {
        case 'text':
        case 'email':
        case 'phone':
        case 'number':
        case 'date':
            inputHTML = `<input type="${field.type}" placeholder="Resposta...">`;
            break;
        case 'textarea':
            inputHTML = `<textarea placeholder="Resposta..." rows="3"></textarea>`;
            break;
        case 'select':
            inputHTML = `<select><option>Selecione...</option>${field.options.map(opt => `<option>${opt}</option>`).join('')}</select>`;
            break;
        case 'radio':
        case 'checkbox':
            inputHTML = field.options.map((opt, i) => `
                <div style="margin: 8px 0;">
                    <input type="${field.type}" id="${field.id}-${i}" name="${field.id}">
                    <label for="${field.id}-${i}" style="margin-left: 8px; color: var(--dark-muted);">${opt}</label>
                </div>
            `).join('');
            break;
    }
    
    fieldDiv.innerHTML = `
        <div class="form-field-header">
            <input class="form-field-label" value="${field.label}" onchange="updateFieldLabel('${field.id}', this.value)">
            <div class="form-field-actions">
                <button class="field-action-btn" onclick="toggleFieldRequired('${field.id}')">
                    <i class="fas fa-asterisk"></i>
                </button>
                ${field.options ? `<button class="field-action-btn" onclick="editFieldOptions('${field.id}')">
                    <i class="fas fa-list"></i>
                </button>` : ''}
                <button class="field-action-btn delete" onclick="removeField('${field.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        ${inputHTML}
    `;
    
    canvas.appendChild(fieldDiv);
}

function updateFieldLabel(fieldId, newLabel) {
    const field = currentFormFields.find(f => f.id === fieldId);
    if (field) field.label = newLabel;
}

function toggleFieldRequired(fieldId) {
    const field = currentFormFields.find(f => f.id === fieldId);
    if (field) {
        field.required = !field.required;
        showToast(field.required ? 'Campo marcado como obrigatório' : 'Campo marcado como opcional', 'info');
    }
}

function editFieldOptions(fieldId) {
    const field = currentFormFields.find(f => f.id === fieldId);
    if (!field) return;
    
    const newOptions = prompt('Digite as opções separadas por vírgula:', field.options.join(', '));
    if (newOptions) {
        field.options = newOptions.split(',').map(opt => opt.trim()).filter(opt => opt);
        // Re-render field
        const fieldDiv = document.querySelector(`[data-field-id="${fieldId}"]`);
        if (fieldDiv) {
            fieldDiv.remove();
            renderField(field);
        }
    }
}

function removeField(fieldId) {
    if (confirm('Deseja remover este campo?')) {
        currentFormFields = currentFormFields.filter(f => f.id !== fieldId);
        const fieldDiv = document.querySelector(`[data-field-id="${fieldId}"]`);
        if (fieldDiv) fieldDiv.remove();
        
        // Show empty state if no fields
        const canvas = document.getElementById('form-canvas');
        if (currentFormFields.length === 0) {
            canvas.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <h3>Arraste campos aqui</h3>
                    <p>Comece a criar seu formulário arrastando campos da paleta</p>
                </div>
            `;
        }
    }
}

function resetFormBuilder() {
    currentFormFields = [];
    currentFormId = null;
    document.getElementById('form-title').value = '';
    document.getElementById('form-description').value = '';
    document.getElementById('form-canvas').innerHTML = `
        <div class="empty-state">
            <i class="fas fa-hand-pointer"></i>
            <h3>Arraste campos aqui</h3>
            <p>Comece a criar seu formulário arrastando campos da paleta</p>
        </div>
    `;
    document.getElementById('create-title').textContent = 'Criar Novo Formulário';
}

// Save Form
document.getElementById('btn-save-form').addEventListener('click', async () => {
    const title = document.getElementById('form-title').value.trim();
    const description = document.getElementById('form-description').value.trim();
    
    if (!title) {
        showToast('Por favor, preencha o título do formulário', 'error');
        return;
    }
    
    if (currentFormFields.length === 0) {
        showToast('Adicione pelo menos um campo ao formulário', 'error');
        return;
    }
    
    const formData = {
        userId: currentUser.id,
        title: title,
        description: description,
        fields: currentFormFields,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    
    try {
        if (currentFormId) {
            formData.id = currentFormId;
            await updateRecord('forms', formData);
            showToast('Formulário atualizado com sucesso!', 'success');
        } else {
            await addRecord('forms', formData);
            showToast('Formulário criado com sucesso!', 'success');
        }
        
        resetFormBuilder();
        navigateTo('forms');
    } catch (error) {
        showToast('Erro ao salvar formulário', 'error');
        console.error(error);
    }
});

// ==========================================================================
// FORMS LIST
// ==========================================================================
async function loadForms() {
    if (!currentUser) return;
    
    const forms = await getAllRecords('forms', 'userId', currentUser.id);
    const container = document.getElementById('forms-list-container');
    
    if (forms.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-file-lines"></i>
                <h3>Nenhum formulário criado</h3>
                <p>Clique em "Novo Formulário" para começar</p>
            </div>
        `;
        return;
    }
    
    const responses = await getAllRecords('responses');
    
    const formsHTML = forms.map(form => {
        const formResponses = responses.filter(r => r.formId === form.id);
        const date = new Date(form.createdAt).toLocaleDateString('pt-BR');
        
        return `
            <div class="form-card">
                <div class="form-card-header">
                    <div>
                        <div class="form-card-title">${form.title}</div>
                        <div class="form-card-description">${form.description || 'Sem descrição'}</div>
                    </div>
                </div>
                <div class="form-card-meta">
                    <div class="form-card-date">
                        <i class="fas fa-calendar"></i> ${date}
                    </div>
                    <div class="form-card-responses">${formResponses.length} respostas</div>
                </div>
                <div class="form-card-actions">
                    <button class="btn-small edit" onclick="editForm(${form.id})">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn-small link" onclick="shareFormLink(${form.id})">
                        <i class="fas fa-link"></i> Link
                    </button>
                    <button class="btn-small delete" onclick="deleteForm(${form.id})">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `<div class="forms-list">${formsHTML}</div>`;
}

async function editForm(formId) {
    const form = await getRecordById('forms', formId);
    if (!form) return;
    
    currentFormId = formId;
    currentFormFields = form.fields || [];
    
    document.getElementById('form-title').value = form.title;
    document.getElementById('form-description').value = form.description || '';
    document.getElementById('create-title').textContent = 'Editar Formulário';
    
    const canvas = document.getElementById('form-canvas');
    canvas.innerHTML = '';
    
    currentFormFields.forEach(field => renderField(field));
    
    navigateTo('create');
}

async function deleteForm(formId) {
    if (!confirm('Deseja realmente excluir este formulário?')) return;
    
    try {
        await deleteRecord('forms', formId);
        showToast('Formulário excluído com sucesso', 'success');
        loadForms();
        loadDashboard();
    } catch (error) {
        showToast('Erro ao excluir formulário', 'error');
        console.error(error);
    }
}

function shareFormLink(formId) {
    const baseUrl = window.location.origin + window.location.pathname;
    const formUrl = `${baseUrl}?form=${formId}`;
    
    document.getElementById('form-link').value = formUrl;
    document.getElementById('link-modal').classList.add('active');
}

function closeLinkModal() {
    document.getElementById('link-modal').classList.remove('active');
}

function copyFormLink() {
    const input = document.getElementById('form-link');
    input.select();
    document.execCommand('copy');
    showToast('Link copiado para a área de transferência!', 'success');
}

// ==========================================================================
// CLIENTS
// ==========================================================================
let currentClientId = null;

async function loadClients() {
    if (!currentUser) return;
    
    const clients = await getAllRecords('clients', 'userId', currentUser.id);
    const tbody = document.getElementById('clients-table-body');
    
    if (clients.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>Nenhum cliente cadastrado</h3>
                        <p>Clique em "Novo Cliente" para adicionar</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    const rows = clients.map(client => `
        <tr>
            <td><strong style="color: var(--dark-text);">${client.name}</strong></td>
            <td>${client.email}</td>
            <td>${client.phone || '-'}</td>
            <td>${client.company || '-'}</td>
            <td><span class="status-badge enviado">Ativo</span></td>
            <td class="table-actions">
                <button class="table-action-btn" onclick="editClient(${client.id})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="table-action-btn" onclick="deleteClient(${client.id})" title="Excluir">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    tbody.innerHTML = rows;
}

function openClientModal() {
    currentClientId = null;
    document.getElementById('client-modal-title').textContent = 'Novo Cliente';
    document.getElementById('client-form').reset();
    document.getElementById('client-modal').classList.add('active');
}

function closeClientModal() {
    document.getElementById('client-modal').classList.remove('active');
    currentClientId = null;
}

async function editClient(clientId) {
    const client = await getRecordById('clients', clientId);
    if (!client) return;
    
    currentClientId = clientId;
    document.getElementById('client-modal-title').textContent = 'Editar Cliente';
    document.getElementById('client-id').value = client.id;
    document.getElementById('client-name').value = client.name;
    document.getElementById('client-email').value = client.email;
    document.getElementById('client-phone').value = client.phone || '';
    document.getElementById('client-company').value = client.company || '';
    document.getElementById('client-position').value = client.position || '';
    document.getElementById('client-notes').value = client.notes || '';
    
    document.getElementById('client-modal').classList.add('active');
}

async function saveClient() {
    const name = document.getElementById('client-name').value.trim();
    const email = document.getElementById('client-email').value.trim();
    
    if (!name || !email) {
        showToast('Preencha os campos obrigatórios', 'error');
        return;
    }
    
    const clientData = {
        userId: currentUser.id,
        name: name,
        email: email,
        phone: document.getElementById('client-phone').value.trim(),
        company: document.getElementById('client-company').value.trim(),
        position: document.getElementById('client-position').value.trim(),
        notes: document.getElementById('client-notes').value.trim(),
        createdAt: currentClientId ? undefined : new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    
    try {
        if (currentClientId) {
            clientData.id = currentClientId;
            await updateRecord('clients', clientData);
            showToast('Cliente atualizado com sucesso!', 'success');
        } else {
            await addRecord('clients', clientData);
            showToast('Cliente cadastrado com sucesso!', 'success');
        }
        
        closeClientModal();
        loadClients();
        loadDashboard();
    } catch (error) {
        showToast('Erro ao salvar cliente', 'error');
        console.error(error);
    }
}

async function deleteClient(clientId) {
    if (!confirm('Deseja realmente excluir este cliente?')) return;
    
    try {
        await deleteRecord('clients', clientId);
        showToast('Cliente excluído com sucesso', 'success');
        loadClients();
        loadDashboard();
    } catch (error) {
        showToast('Erro ao excluir cliente', 'error');
        console.error(error);
    }
}

// ==========================================================================
// RESPONSES
// ==========================================================================
async function loadResponses() {
    if (!currentUser) return;
    
    const responses = await getAllRecords('responses', 'userId', currentUser.id);
    const container = document.getElementById('responses-container');
    
    if (responses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>Nenhuma resposta recebida</h3>
                <p>As respostas aparecerão aqui quando os formulários forem preenchidos</p>
            </div>
        `;
        return;
    }
    
    const forms = await getAllRecords('forms');
    
    const responsesHTML = responses.map(response => {
        const form = forms.find(f => f.id === response.formId);
        const date = new Date(response.submittedAt).toLocaleString('pt-BR');
        
        return `
            <div class="response-card">
                <div class="response-header">
                    <div>
                        <strong style="color: var(--dark-text); font-size: 1.1rem;">${form?.title || 'Formulário'}</strong>
                    </div>
                    <div class="response-meta">
                        <span><i class="fas fa-calendar"></i> ${date}</span>
                        <span class="status-badge ${response.status}">${response.status}</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-small edit" onclick="viewResponse(${response.id})">
                        <i class="fas fa-eye"></i> Visualizar
                    </button>
                    <button class="btn-small delete" onclick="deleteResponse(${response.id})">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = responsesHTML;
}

async function viewResponse(responseId) {
    const response = await getRecordById('responses', responseId);
    if (!response) return;
    
    const form = await getRecordById('forms', response.formId);
    
    const fieldsHTML = Object.entries(response.answers).map(([fieldId, answer]) => {
        const field = form.fields.find(f => f.id === fieldId);
        return `
            <div class="response-field">
                <div class="response-label">${field?.label || 'Campo'}</div>
                <div class="response-value">${Array.isArray(answer) ? answer.join(', ') : answer}</div>
            </div>
        `;
    }).join('');
    
    document.getElementById('response-modal-body').innerHTML = fieldsHTML;
    document.getElementById('response-modal').classList.add('active');
}

function closeResponseModal() {
    document.getElementById('response-modal').classList.remove('active');
}

async function deleteResponse(responseId) {
    if (!confirm('Deseja realmente excluir esta resposta?')) return;
    
    try {
        await deleteRecord('responses', responseId);
        showToast('Resposta excluída com sucesso', 'success');
        loadResponses();
        loadDashboard();
    } catch (error) {
        showToast('Erro ao excluir resposta', 'error');
        console.error(error);
    }
}

// ==========================================================================
// FORM SUBMISSION (Public Page)
// ==========================================================================
async function checkPublicFormSubmission() {
    const urlParams = new URLSearchParams(window.location.search);
    const formId = urlParams.get('form');
    
    if (formId) {
        // This is a public form submission
        await renderPublicForm(parseInt(formId));
    }
}

async function renderPublicForm(formId) {
    await openDB();
    const form = await getRecordById('forms', formId);
    
    if (!form) {
        document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: var(--dark-bg); color: white;">
                <div style="text-align: center;">
                    <i class="fas fa-exclamation-circle" style="font-size: 4rem; color: var(--danger); margin-bottom: 20px;"></i>
                    <h1>Formulário não encontrado</h1>
                    <p>O formulário que você está tentando acessar não existe.</p>
                </div>
            </div>
        `;
        return;
    }
    
    const fieldsHTML = form.fields.map(field => {
        let inputHTML = '';
        
        switch(field.type) {
            case 'text':
            case 'email':
            case 'phone':
            case 'number':
            case 'date':
                inputHTML = `<input type="${field.type}" id="${field.id}" ${field.required ? 'required' : ''} style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 8px; color: white; font-size: 0.95rem;">`;
                break;
            case 'textarea':
                inputHTML = `<textarea id="${field.id}" rows="4" ${field.required ? 'required' : ''} style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 8px; color: white; font-size: 0.95rem;"></textarea>`;
                break;
            case 'select':
                inputHTML = `<select id="${field.id}" ${field.required ? 'required' : ''} style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.2); border-radius: 8px; color: white; font-size: 0.95rem;">
                    <option value="">Selecione...</option>
                    ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                </select>`;
                break;
            case 'radio':
                inputHTML = field.options.map((opt, i) => `
                    <div style="margin: 10px 0;">
                        <input type="radio" id="${field.id}-${i}" name="${field.id}" value="${opt}" ${field.required && i === 0 ? 'required' : ''}>
                        <label for="${field.id}-${i}" style="margin-left: 10px; color: var(--dark-muted);">${opt}</label>
                    </div>
                `).join('');
                break;
            case 'checkbox':
                inputHTML = field.options.map((opt, i) => `
                    <div style="margin: 10px 0;">
                        <input type="checkbox" id="${field.id}-${i}" name="${field.id}" value="${opt}">
                        <label for="${field.id}-${i}" style="margin-left: 10px; color: var(--dark-muted);">${opt}</label>
                    </div>
                `).join('');
                break;
        }
        
        return `
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; color: white; margin-bottom: 10px; font-size: 0.95rem;">
                    ${field.label} ${field.required ? '<span style="color: var(--danger);">*</span>' : ''}
                </label>
                ${inputHTML}
            </div>
        `;
    }).join('');
    
    document.body.innerHTML = `
        <div style="min-height: 100vh; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 40px 20px;">
            <div style="max-width: 700px; margin: 0 auto; background: rgba(30,41,59,0.8); backdrop-filter: blur(20px); border: 1px solid rgba(148,163,184,0.2); border-radius: 16px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                <div style="text-align: center; margin-bottom: 40px;">
                    <i class="fas fa-file-lines" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                    <h1 style="font-size: 2rem; font-weight: 800; color: white; margin-bottom: 10px;">${form.title}</h1>
                    ${form.description ? `<p style="color: var(--dark-muted); font-size: 1rem;">${form.description}</p>` : ''}
                </div>
                
                <form id="public-form">
                    ${fieldsHTML}
                    
                    <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 15px rgba(59,130,246,0.3);">
                        <i class="fas fa-paper-plane"></i> Enviar Resposta
                    </button>
                </form>
            </div>
        </div>
    `;
    
    document.getElementById('public-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const answers = {};
        
        form.fields.forEach(field => {
            if (field.type === 'checkbox') {
                const checked = Array.from(document.querySelectorAll(`input[name="${field.id}"]:checked`)).map(cb => cb.value);
                answers[field.id] = checked;
            } else if (field.type === 'radio') {
                const selected = document.querySelector(`input[name="${field.id}"]:checked`);
                answers[field.id] = selected ? selected.value : '';
            } else {
                answers[field.id] = document.getElementById(field.id).value;
            }
        });
        
        const response = {
            userId: form.userId,
            formId: form.id,
            answers: answers,
            submittedAt: new Date().toISOString(),
            status: 'recebido'
        };
        
        await addRecord('responses', response);
        
        document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white;">
                <div style="text-align: center;">
                    <i class="fas fa-check-circle" style="font-size: 5rem; color: var(--success); margin-bottom: 25px;"></i>
                    <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 15px;">Resposta Enviada!</h1>
                    <p style="font-size: 1.1rem; color: var(--dark-muted);">Obrigado por preencher o formulário.</p>
                </div>
            </div>
        `;
    });
}

// ==========================================================================
// TOAST NOTIFICATIONS
// ==========================================================================
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
    
    toast.innerHTML = `
        <i class="fas ${icon}"></i>
        <div class="toast-message">${message}</div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideInRight 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ==========================================================================
// SUPABASE SYNC (Advanced)
// ==========================================================================
const SYNC_TABLE = 'formflow_sync';
const CANONICAL_DB = DB_NAME;
const DEVICE_ID = 'device-' + Math.random().toString(36).substr(2, 9);

let isReplicating = false;
let syncCache = new Map();
let syncInterval = null;

async function waitForSupabase() {
    return await initSupabase();
}

function getClient() {
    return supabaseClient;
}

async function getUserId() {
    const client = await waitForSupabase();
    const { data } = await client.auth.getSession();
    return data?.session?.user?.id || null;
}

function generateSignature(value) {
    if (value === null || value === undefined) return 'null';
    return JSON.stringify(value);
}

const original = {
    put: IDBObjectStore.prototype.put,
    add: IDBObjectStore.prototype.add,
    delete: IDBObjectStore.prototype.delete
};

async function scheduleRealtimeUpload(storeName, method, key, value) {
    if (isReplicating) return;
    
    const client = getClient();
    const userId = await getUserId();
    if (!client || !userId) return;
    
    const cacheKey = `${storeName}-${key}`;
    
    if (method === 'delete') {
        syncCache.delete(cacheKey);
    } else {
        syncCache.set(cacheKey, generateSignature(value));
    }
    
    client.from(SYNC_TABLE).upsert({
        user_id: userId,
        db_name: CANONICAL_DB,
        store_name: storeName,
        record_key: String(key),
        record_value: method === 'delete' ? null : value,
        is_deleted: method === 'delete',
        device_id: DEVICE_ID,
        updated_at: new Date().toISOString()
    }, { onConflict: 'user_id,db_name,store_name,record_key' })
    .then(({ error }) => {
        if (error) console.warn(`⚠️ Sync Upload Failed:`, error.message);
    });
}

IDBObjectStore.prototype.put = function (v, k) {
    const req = original.put.apply(this, arguments);
    const storeName = this.name;
    req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'put', k || e.target.result, v);
    return req;
};

IDBObjectStore.prototype.add = function (v, k) {
    const req = original.add.apply(this, arguments);
    const storeName = this.name;
    req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'add', k || e.target.result, v);
    return req;
};

IDBObjectStore.prototype.delete = function (k) {
    const req = original.delete.apply(this, arguments);
    const storeName = this.name;
    req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'delete', k, null);
    return req;
};

async function smartUploadLoop() {
    const userId = await getUserId();
    const client = getClient();
    if (!userId || !client) return;
    
    const req = indexedDB.open(CANONICAL_DB);
    
    req.onsuccess = (e) => {
        const database = e.target.result;
        const storeNames = Array.from(database.objectStoreNames);
        
        storeNames.forEach(storeName => {
            const tx = database.transaction([storeName], 'readonly');
            const store = tx.objectStore(storeName);
            
            Promise.all([
                new Promise(r => store.getAll().onsuccess = (ev) => r(ev.target.result)),
                new Promise(r => store.getAllKeys().onsuccess = (ev) => r(ev.target.result))
            ]).then(async ([records, keys]) => {
                if (!records.length) return;
                
                const changedRecords = [];
                
                records.forEach((item, index) => {
                    const key = String(keys[index]);
                    const cacheKey = `${storeName}-${key}`;
                    const currentSig = generateSignature(item);
                    
                    if (syncCache.get(cacheKey) !== currentSig) {
                        changedRecords.push({
                            user_id: userId,
                            db_name: CANONICAL_DB,
                            store_name: storeName,
                            record_key: key,
                            record_value: item,
                            is_deleted: false,
                            device_id: DEVICE_ID,
                            updated_at: new Date().toISOString()
                        });
                        syncCache.set(cacheKey, currentSig);
                    }
                });
                
                if (changedRecords.length > 0) {
                    console.log(`📤 Syncing ${changedRecords.length} records`);
                    await client.from(SYNC_TABLE).upsert(changedRecords, { 
                        onConflict: 'user_id,db_name,store_name,record_key' 
                    });
                }
            });
        });
    };
}

async function smartDownloadLoop() {
    const userId = await getUserId();
    const client = getClient();
    if (!userId || !client) return;
    
    const { data, error } = await client
        .from(SYNC_TABLE)
        .select('*')
        .eq('user_id', userId)
        .eq('db_name', CANONICAL_DB);
    
    if (error || !data || !data.length) return;
    
    const req = indexedDB.open(CANONICAL_DB);
    req.onsuccess = (e) => {
        const database = e.target.result;
        const localStores = Array.from(database.objectStoreNames);
        
        const validRecords = data.filter(r => localStores.includes(r.store_name));
        if (!validRecords.length) return;
        
        const tx = database.transaction([...new Set(validRecords.map(r => r.store_name))], 'readwrite');
        isReplicating = true;
        
        let writes = 0;
        
        validRecords.forEach(r => {
            if (r.device_id === DEVICE_ID) return;
            
            const store = tx.objectStore(r.store_name);
            const key = !isNaN(r.record_key) ? Number(r.record_key) : r.record_key;
            const cacheKey = `${r.store_name}-${r.record_key}`;
            
            if (r.is_deleted) {
                store.delete(key);
                if (syncCache.has(cacheKey)) {
                    syncCache.delete(cacheKey);
                    writes++;
                }
                return;
            }
            
            const incomingSig = generateSignature(r.record_value);
            const localSig = syncCache.get(cacheKey);
            
            if (incomingSig === localSig) return;
            
            const val = r.record_value;
            if (store.keyPath && val && typeof val === 'object') {
                if (!val[store.keyPath]) val[store.keyPath] = key;
                store.put(val);
            } else {
                store.put(val, key);
            }
            
            syncCache.set(cacheKey, incomingSig);
            writes++;
        });
        
        tx.oncomplete = () => {
            isReplicating = false;
            if (writes > 0) console.log(`📥 Downloaded ${writes} changes`);
        };
        
        tx.onerror = () => isReplicating = false;
    };
}

async function startService() {
    const userId = await getUserId();
    if (!userId) return;
    
    console.log('🔄 Starting Sync Service for user:', userId);
    const client = getClient();
    
    client.channel('formflow-sync')
        .on('postgres_changes', { 
            event: '*', 
            schema: 'public', 
            table: SYNC_TABLE, 
            filter: `user_id=eq.${userId}` 
        }, payload => {
            if (payload.new && payload.new.device_id !== DEVICE_ID) {
                smartDownloadLoop();
            }
        })
        .subscribe();
    
    await smartUploadLoop();
    setTimeout(smartDownloadLoop, 500);
    
    if (syncInterval) clearInterval(syncInterval);
    syncInterval = setInterval(async () => {
        await smartUploadLoop();
        await smartDownloadLoop();
    }, 10000);
}

// ==========================================================================
// INITIALIZATION
// ==========================================================================
(async function init() {
    await openDB();
    await initSupabase();
    
    // Check if public form
    await checkPublicFormSubmission();
    
    // Setup auth listener
    const client = await waitForSupabase();
    client.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session) {
            handleAuthSuccess(session.user);
            startService();
        } else if (event === 'SIGNED_OUT') {
            document.body.classList.remove('authenticated');
            document.body.classList.add('not-authenticated');
        }
    });
})();
</script>
</body>
</html>
