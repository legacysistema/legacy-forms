<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FormFlow ¬∑ Enterprise 2.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* --- VARI√ÅVEIS E RESET --- */
:root {
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --secondary: #6366f1;
  --accent: #8b5cf6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --dark: #0f172a;
  --light: #f8fafc;
  --text-main: #1e293b;
  --text-muted: #64748b;
  
  --glass-bg: rgba(255, 255, 255, 0.65);
  --glass-border: 1px solid rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
  --blur: blur(16px);
  --radius: 24px;
}

* { box-sizing: border-box; outline: none; }

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: radial-gradient(circle at top left, #e0e7ff, #f8fafc, #f3e8ff);
  color: var(--text-main);
  height: 100vh;
  display: flex;
  overflow: hidden;
}

/* ==========================================================================
   TELA DE LOGIN (Importado do Legacy Cloud V6)
   ========================================================================== */
#supabase-login-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.login-card {
    background: white;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    width: 100%;
    max-width: 400px;
    text-align: center;
    animation: slideUpLogin 0.5s ease;
}

@keyframes slideUpLogin { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.login-logo {
    font-size: 3rem;
    color: var(--primary);
    margin-bottom: 10px;
}

.login-title { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
.login-subtitle { color: #64748b; font-size: 0.9rem; margin-bottom: 30px; }

.login-form-group { margin-bottom: 15px; text-align: left; }
.login-form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #475569; }
.login-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.3s; }
.login-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

.btn-login {
    width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px;
    font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px;
}
.btn-login:hover { background: var(--primary-dark); }
.btn-login:disabled { background: #94a3b8; cursor: not-allowed; }

.login-error {
    color: #ef4444; font-size: 0.85rem; margin-top: 15px; display: none; background: #fef2f2; padding: 10px; border-radius: 6px; border: 1px solid #fecaca;
}

/* Ocultar elementos do sistema enquanto n√£o logado */
body.not-authenticated aside,
body.not-authenticated main {
    display: none !important;
}

/* Ocultar login quando autenticado */
body.authenticated #supabase-login-overlay {
    display: none !important;
}

/* --- SIDEBAR --- */
aside {
  width: 280px;
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(20px);
  color: white;
  padding: 30px 20px;
  display: flex;
  flex-direction: column;
  box-shadow: 5px 0 30px rgba(0,0,0,0.1);
  z-index: 10;
}

aside .brand {
  font-size: 1.4rem;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 40px;
  padding-left: 10px;
  background: linear-gradient(to right, #60a5fa, #a78bfa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

aside nav button {
  width: 100%;
  background: transparent;
  border: none;
  color: #94a3b8;
  padding: 16px 20px;
  text-align: left;
  cursor: pointer;
  border-radius: 12px;
  font-weight: 500;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 5px;
}

aside nav button i { width: 20px; text-align: center; }

aside nav button:hover, aside nav button.active {
  background: rgba(255,255,255,0.1);
  color: white;
  transform: translateX(5px);
}

/* Estilo Especial para o Bot√£o do Drive */
.btn-drive-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}
.drive-icon {
    background: linear-gradient(135deg, #34A853, #4285F4, #FBBC04);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 1.1rem;
}
.edit-link-btn {
    opacity: 0.5;
    padding: 5px;
    border-radius: 4px;
    transition: 0.2s;
}
.edit-link-btn:hover {
    opacity: 1;
    background: rgba(255,255,255,0.2);
    color: white;
}

aside .user-profile {
  margin-top: auto;
  padding-top: 20px;
  border-top: 1px solid rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
aside .user-avatar {
  width: 40px; height: 40px; border-radius: 50%; background: var(--primary);
  display: flex; justify-content: center; align-items: center; font-weight: bold;
}

.btn-logout-sidebar {
    background: transparent;
    border: none;
    color: #fca5a5;
    cursor: pointer;
    font-size: 1.1rem;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s;
}
.btn-logout-sidebar:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

/* --- MAIN CONTENT --- */
main {
  flex: 1;
  padding: 40px;
  overflow-y: auto;
  position: relative;
}

header { margin-bottom: 40px; }
header h1 { font-size: 2rem; font-weight: 800; margin: 0 0 5px 0; color: var(--dark); letter-spacing: -1px; }
header p { color: var(--text-muted); margin: 0; font-size: 1rem; }

/* --- KPI CARDS --- */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 25px;
  margin-bottom: 40px;
}

.kpi-card {
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border: var(--glass-border);
  border-radius: var(--radius);
  padding: 25px;
  box-shadow: var(--glass-shadow);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  position: relative;
  overflow: hidden;
}

.kpi-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
.kpi-card::before {
  content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
  background: var(--primary);
}
.kpi-card.warning::before { background: var(--warning); }
.kpi-card.success::before { background: var(--success); }
.kpi-card.purple::before { background: var(--accent); }

.kpi-card h3 { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 10px 0; }
.kpi-card .value { font-size: 2.2rem; font-weight: 800; color: var(--dark); }
.kpi-card .icon { position: absolute; right: 20px; top: 25px; font-size: 2rem; opacity: 0.1; }

/* --- ACTION BAR & FORMS --- */
.action-area {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

.glass-panel {
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border: var(--glass-border);
  border-radius: var(--radius);
  padding: 30px;
  box-shadow: var(--glass-shadow);
  flex: 1;
  min-width: 300px;
}

.glass-panel h3 { margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }

.input-group { margin-bottom: 15px; position: relative; }
.input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
.form-control {
  width: 100%;
  padding: 12px 15px 12px 45px;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  background: rgba(255,255,255,0.8);
  transition: all 0.3s;
  font-size: 0.95rem;
}
.form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); background: white; }

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
.btn:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
.btn:active { transform: translateY(0); }

.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; width: 100%; justify-content: center; }
.btn-sm { padding: 8px 16px; font-size: 0.8rem; width: auto; }
.btn-success { background: var(--success); color: white; }
.btn-warning { background: var(--warning); color: white; }
.btn-zap { background: #25D366; color: white; }
.btn-outline { background: transparent; border: 1px solid var(--text-muted); color: var(--text-main); }

/* --- DATA TABLE MODERNIZADA --- */
.table-container {
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--glass-shadow);
  overflow: hidden;
  border: 1px solid rgba(0,0,0,0.05);
}

table { width: 100%; border-collapse: collapse; }
thead { background: #f1f5f9; }
th { text-align: left; padding: 18px 24px; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
td { padding: 18px 24px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: #f8fafc; }

/* Status Badges */
.badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.badge-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

/* Cores dos Status */
.st-created { background: #e0e7ff; color: #3730a3; }
.st-sent { background: #dbeafe; color: #1e40af; } /* Enviado Zap */
.st-answered { background: #dcfce7; color: #166534; } /* Cliente Respondeu */
.st-project { background: #f3e8ff; color: #6b21a8; } /* Em Projeto */
.st-approval { background: #ffedd5; color: #9a3412; } /* Aguardando Aprova√ß√£o */
.st-done { background: #10b981; color: #fff; }

/* Loading Overlay */
#loader {
  position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
  z-index: 999; display: flex; justify-content: center; align-items: center;
  transition: opacity 0.5s; opacity: 1; pointer-events: all;
}
#loader.hide { opacity: 0; pointer-events: none; }
.spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

</style>
</head>
<body class="not-authenticated">

<div id="supabase-login-overlay">
    <div class="login-card">
        <div class="login-logo"><i class="fa-solid fa-layer-group"></i></div>
        <h1 class="login-title">FormFlow 2.0</h1>
        <p class="login-subtitle">Gest√£o Inteligente</p>
        
        <div class="login-form-group">
            <label>Email de Acesso</label>
            <input type="email" id="login-email" class="login-input" placeholder="seu@email.com" onkeydown="if(event.key === 'Enter') document.getElementById('login-password').focus()">
        </div>
        
        <div class="login-form-group">
            <label>Senha</label>
            <input type="password" id="login-password" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key === 'Enter') authManager.login()">
        </div>

        <div class="login-error" id="login-error-msg"></div>

        <button class="btn-login" onclick="authManager.login()" id="btn-do-login">Entrar no Sistema</button>
        <p style="margin-top:20px; font-size:0.75rem; color:#94a3b8;">Sistema protegido e criptografado.</p>
    </div>
</div>

<div id="loader"><div class="spinner"></div></div>

<aside>
  <div class="brand">
    <i class="fa-solid fa-layer-group"></i> FormFlow 2.0
  </div> 
  <nav>
     <button class="active"><i class="fa-solid fa-house"></i> Painel Principal</button>
     
     <button onclick="DriveApp.open()" class="btn-drive-wrapper">
        <div style="display:flex; align-items:center; gap:12px">
            <i class="fa-brands fa-google-drive drive-icon"></i> 
            Google Drive
        </div>
        <div class="edit-link-btn" onclick="event.stopPropagation(); DriveApp.edit()" title="Alterar Link do Drive">
            <i class="fa-solid fa-pen" style="font-size: 0.8rem;"></i>
        </div>
     </button>
  </nav>

  <div class="user-profile">
    <div style="display:flex; align-items:center; gap:10px;">
        <div class="user-avatar">AD</div>
        <div>
          <div style="font-weight: 600; font-size: 0.9rem">Admin</div>
          <div style="font-size: 0.7rem; color: #94a3b8; display:flex; align-items:center; gap:4px">
            <span style="width:6px; height:6px; background:#10b981; border-radius:50%"></span> Online
          </div>
        </div>
    </div>
    <button class="btn-logout-sidebar" onclick="authManager.logout()" title="Sair do Sistema">
        <i class="fa-solid fa-sign-out-alt"></i>
    </button>
  </div>
</aside>

<main>
  <header>
    <h1>Gest√£o Inteligente de Formul√°rios</h1>
    <p>Sistema legado modernizado com IndexedDB Nativo</p>
  </header>

  <section class="cards-grid">
    <div class="kpi-card">
      <div class="icon"><i class="fa-solid fa-clock"></i></div>
      <h3>Aguardando Envio</h3>
      <div class="value" id="kpiPending">0</div>
    </div>
    <div class="kpi-card warning">
      <div class="icon"><i class="fa-solid fa-hourglass-half"></i></div>
      <h3>Resposta Pendente</h3>
      <div class="value" id="kpiSent">0</div>
    </div>
    <div class="kpi-card purple">
      <div class="icon"><i class="fa-solid fa-pen-ruler"></i></div>
      <h3>Em Projeto</h3>
      <div class="value" id="kpiProject">0</div>
    </div>
    <div class="kpi-card success">
      <div class="icon"><i class="fa-solid fa-check-circle"></i></div>
      <h3>Finalizados</h3>
      <div class="value" id="kpiDone">0</div>
    </div>
  </section>

  <div class="action-area">
    <div class="glass-panel">
      <h3><i class="fa-solid fa-user-plus" style="color:var(--primary)"></i> Novo Cliente</h3>
      <div class="input-group">
        <i class="fa-regular fa-user"></i>
        <input id="inName" class="form-control" placeholder="Nome do Cliente">
      </div>
      <div class="input-group">
        <i class="fa-brands fa-whatsapp"></i>
        <input id="inPhone" class="form-control" placeholder="WhatsApp (apenas n√∫meros)">
      </div>
      <button class="btn btn-primary" onclick="App.addClient()">
        <i class="fa-solid fa-save"></i> Salvar Cliente
      </button>
    </div>

    <div class="glass-panel">
      <h3><i class="fa-brands fa-google" style="color:var(--danger)"></i> Novo Fluxo de Formul√°rio</h3>
      <div class="input-group">
        <i class="fa-solid fa-users"></i>
        <select id="selClient" class="form-control">
          <option value="" disabled selected>Selecione o Cliente</option>
        </select>
      </div>
      <div class="input-group">
        <i class="fa-solid fa-link"></i>
        <input id="inLink" class="form-control" placeholder="Link do Google Forms">
      </div>
      <button class="btn btn-primary" onclick="App.addFormFlow()">
        <i class="fa-solid fa-play"></i> Iniciar Fluxo
      </button>
    </div>
  </div>

  <div class="table-container">
    <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin:0">Fluxos Ativos</h3>
      <div style="font-size:0.8rem; color:var(--text-muted)"><i class="fa-solid fa-sync fa-spin"></i> Banco de Dados Local</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Formul√°rio</th>
          <th>Status Atual</th>
          <th>Pr√≥xima A√ß√£o (Automa√ß√£o)</th>
          <th>Op√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        </tbody>
    </table>
  </div>
</main>


<script>
// =========================================================================
// CONFIGURA√á√ÉO SUPABASE & AUTENTICA√á√ÉO
// =========================================================================
const SUPABASE_URL = 'https://rjyxkouegrropsarrhje.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeXhrb3VlZ3Jyb3BzYXJyaGplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjYxNjcsImV4cCI6MjA4NTE0MjE2N30.UjNPnVBVhQcUSirXeWZ3RmYmAhDMqqbbVUChG_Mv57U';

window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


const authManager = {
    init: async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        authManager.updateUI(session);
        supabaseClient.auth.onAuthStateChange((event, session) => {
            authManager.updateUI(session);
        });
    },
    updateUI: (session) => {
        const body = document.body;
        if (session) {
            body.classList.remove('not-authenticated');
            body.classList.add('authenticated');
            if (typeof App !== 'undefined') { App.init(); }
        } else {
            body.classList.remove('authenticated');
            body.classList.add('not-authenticated');
        }
    },
    login: async () => {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorMsg = document.getElementById('login-error-msg');
        const btn = document.getElementById('btn-do-login');

        if (!email || !password) { authManager.showError('Preencha email e senha.'); return; }

        btn.innerText = 'Autenticando...';
        btn.disabled = true;
        errorMsg.style.display = 'none';

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email: email, password: password });
        btn.innerText = 'Entrar no Sistema';
        btn.disabled = false;
        if (error) { authManager.showError('Erro: ' + error.message); }
    },
    logout: async () => {
        if(confirm("Deseja sair do sistema?")) { await supabaseClient.auth.signOut(); }
    },
    showError: (msg) => {
        const el = document.getElementById('login-error-msg');
        el.innerText = msg;
        el.style.display = 'block';
    }
};

authManager.init();
  
/**
 * DB SERVICE - Gerenciador do lg_crmDB
 */
const DBService = {
    dbName: 'lg_crmDB',
    stores: {
        CLIENTS: 'clientsform',
        FLOWS: 'flowsform'
    },
    
    // Abre o banco e cria as tabelas se necess√°rio (Incrementa vers√£o automaticamente se faltar tabela)
    open: function() {
        return new Promise((resolve, reject) => {
            // Primeiro tenta abrir para checar as tabelas
            const request = indexedDB.open(this.dbName);
            
            request.onsuccess = (e) => {
                const db = e.target.result;
                const storeNames = Array.from(db.objectStoreNames);
                const needsUpgrade = !storeNames.includes(this.stores.CLIENTS) || !storeNames.includes(this.stores.FLOWS);
                
                if (needsUpgrade) {
                    const newVersion = db.version + 1;
                    db.close();
                    this._openWithUpgrade(newVersion, resolve, reject);
                } else {
                    resolve(db);
                }
            };
            
            request.onupgradeneeded = (e) => this._handleUpgrade(e);
            request.onerror = (e) => reject(e);
        });
    },
    
    _openWithUpgrade: function(version, resolve, reject) {
        const request = indexedDB.open(this.dbName, version);
        request.onupgradeneeded = (e) => this._handleUpgrade(e);
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject(e);
    },

    _handleUpgrade: function(e) {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(this.stores.CLIENTS)) {
            db.createObjectStore(this.stores.CLIENTS, { keyPath: 'id' });
        }
        if (!db.objectStoreNames.contains(this.stores.FLOWS)) {
            db.createObjectStore(this.stores.FLOWS, { keyPath: 'id' });
        }
    },

    // Opera√ß√µes CRUD Gen√©ricas
    getAll: async function(storeName) {
        const db = await this.open();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    },
    
    put: async function(storeName, data) {
        const db = await this.open();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const req = store.put(data);
            tx.oncomplete = () => resolve(req.result);
            tx.onerror = () => reject(tx.error);
        });
    },

    delete: async function(storeName, key) {
        const db = await this.open();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const req = store.delete(key);
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }
};

/**
 * DRIVE APP - Gerenciador do Link Google Drive (Mantido em LocalStorage por ser config simples)
 */
const DriveApp = {
    key: 'ff_drive_link',
    open: () => {
        const link = localStorage.getItem(DriveApp.key);
        if (!link) { DriveApp.edit(); } else { window.open(link, '_blank'); }
    },
    edit: async () => {
        const current = localStorage.getItem(DriveApp.key) || '';
        const { value: url } = await Swal.fire({
            title: 'Configurar Google Drive', input: 'url', inputValue: current,
            inputLabel: 'Cole o link da pasta ou arquivo do Drive', inputPlaceholder: 'https://drive.google.com/...',
            showCancelButton: true, confirmButtonText: 'Salvar Link', cancelButtonText: 'Cancelar'
        });
        if (url) {
            localStorage.setItem(DriveApp.key, url);
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
            Toast.fire({ icon: 'success', title: 'Link do Drive atualizado!' });
        }
    }
};

/**
 * FORMFLOW 2.0 - L√≥gica de Neg√≥cio (Adaptado para IndexedDB)
 */
const App = {
  data: {
    clients: [],
    forms: []
  },
  statusMap: {
    'CRIADO': { label: 'Aguardando Envio', class: 'st-created', icon: 'fa-regular fa-paper-plane' },
    'ENVIADO': { label: 'Aguardando Resposta', class: 'st-sent', icon: 'fa-solid fa-hourglass-start' },
    'RESPONDIDO': { label: 'Em Projeto', class: 'st-project', icon: 'fa-solid fa-layer-group' },
    'APROVACAO': { label: 'Aguardando Aprova√ß√£o', class: 'st-approval', icon: 'fa-solid fa-magnifying-glass' },
    'FINALIZADO': { label: 'Aprovado & Finalizado', class: 'st-done', icon: 'fa-solid fa-check-double' }
  },
  
  async init() {
    await this.refreshData();
    this.render();
    setTimeout(() => { document.getElementById('loader').classList.add('hide'); }, 500);
  },

  async refreshData() {
    try {
        this.data.clients = await DBService.getAll(DBService.stores.CLIENTS);
        this.data.forms = await DBService.getAll(DBService.stores.FLOWS);
    } catch (e) {
        console.error("Erro ao carregar dados do IDB:", e);
    }
  },

  async addClient() {
    const name = document.getElementById('inName').value.trim();
    let phone = document.getElementById('inPhone').value.replace(/\D/g, ''); 
    if (!name || phone.length < 10) { return Swal.fire('Aten√ß√£o', 'Preencha nome e um WhatsApp v√°lido (com DDD).', 'warning'); }
    if (!phone.startsWith('55')) phone = '55' + phone;
    
    const newClient = { id: Date.now(), name, phone };
    await DBService.put(DBService.stores.CLIENTS, newClient);
    
    document.getElementById('inName').value = '';
    document.getElementById('inPhone').value = '';
    
    await this.refreshData();
    this.render();
    this.toast('Cliente cadastrado com sucesso!');
  },

  async addFormFlow() {
    const clientId = document.getElementById('selClient').value;
    const link = document.getElementById('inLink').value.trim();
    if (!clientId || !link) { return Swal.fire('Campos vazios', 'Selecione um cliente e cole o link do Google Forms.', 'warning'); }
    
    // Necess√°rio achar o cliente na mem√≥ria ou no DB. Como init carrega tudo, usamos mem√≥ria.
    const client = this.data.clients.find(c => c.id == clientId);
    if (!client) return Swal.fire('Erro', 'Cliente n√£o encontrado.', 'error');

    const newForm = {
      id: Date.now(), clientId: client.id, clientName: client.name, clientPhone: client.phone, link: link, status: 'CRIADO', updated: Date.now()
    };
    
    await DBService.put(DBService.stores.FLOWS, newForm);
    document.getElementById('inLink').value = '';
    
    await this.refreshData();
    this.render();
    this.toast('Novo fluxo iniciado!');
  },

  async updateStatus(id, newStatus, extraAction = null) {
      const f = this.data.forms.find(x => x.id === id);
      if(!f) return;
      f.status = newStatus;
      f.updated = Date.now();
      
      await DBService.put(DBService.stores.FLOWS, f);
      if(extraAction) extraAction(f);
      
      await this.refreshData();
      this.render();
  },

  actionSend(id) {
    const f = this.data.forms.find(x => x.id === id);
    const msg = `Ol√° ${f.clientName}! Aqui est√° o link para o formul√°rio que precisamos que preencha: ${f.link}`;
    this.openWhats(f.clientPhone, msg);
    this.updateStatus(id, 'ENVIADO');
  },

  actionCheck(id) {
    Swal.fire({
      title: 'Cliente respondeu?', text: 'Isso mover√° o status para "Em Projeto".', icon: 'question', showCancelButton: true, confirmButtonText: 'Sim, iniciar projeto', cancelButtonText: 'Ainda n√£o'
    }).then((result) => {
      if (result.isConfirmed) { 
          this.updateStatus(id, 'RESPONDIDO', () => this.toast('Status atualizado para Em Projeto'));
      }
    });
  },

  actionSendApproval(id) {
    const f = this.data.forms.find(x => x.id === id);
    Swal.fire({
      title: 'Projeto conclu√≠do?', text: 'Enviar mensagem de aprova√ß√£o para o cliente?', icon: 'info', showCancelButton: true, confirmButtonText: 'Enviar Zap e Atualizar'
    }).then((result) => {
      if (result.isConfirmed) {
        const msg = `Ol√° ${f.clientName}! Seu projeto est√° pronto para an√°lise. Aguardo seu OK para finalizar.`;
        this.openWhats(f.clientPhone, msg);
        this.updateStatus(id, 'APROVACAO');
      }
    });
  },

  actionApprove(id) {
    Swal.fire({
      title: 'Aprovar Projeto?', text: 'O fluxo ser√° encerrado como Sucesso.', icon: 'success', showCancelButton: true, confirmButtonText: 'Aprovar Final'
    }).then((result) => {
      if (result.isConfirmed) { 
          this.updateStatus(id, 'FINALIZADO', () => this.toast('Projeto Finalizado com Sucesso!', 'success'));
      }
    });
  },

  deleteForm(id) {
    Swal.fire({
        title: 'Tem certeza?', text: "N√£o ser√° poss√≠vel reverter!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sim, excluir'
    }).then(async (result) => {
        if (result.isConfirmed) { 
            await DBService.delete(DBService.stores.FLOWS, id);
            await this.refreshData();
            this.render();
            this.toast('Fluxo exclu√≠do.');
        }
    })
  },

  render() {
    const sel = document.getElementById('selClient');
    sel.innerHTML = '<option value="" disabled selected>Selecione o Cliente</option>' + this.data.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    let kpi = { pending: 0, sent: 0, project: 0, done: 0 };
    const sortedForms = [...this.data.forms].sort((a,b) => b.updated - a.updated);
    
    sortedForms.forEach(f => {
      if (f.status === 'CRIADO') kpi.pending++;
      if (f.status === 'ENVIADO') kpi.sent++;
      if (f.status === 'RESPONDIDO' || f.status === 'APROVACAO') kpi.project++;
      if (f.status === 'FINALIZADO') kpi.done++;
      
      const stConfig = this.statusMap[f.status];
      let actionBtn = '';
      switch(f.status) {
        case 'CRIADO': actionBtn = `<button class="btn btn-sm btn-zap" onclick="App.actionSend(${f.id})"><i class="fa-brands fa-whatsapp"></i> Enviar Link</button>`; break;
        case 'ENVIADO': actionBtn = `<button class="btn btn-sm btn-primary" onclick="App.actionCheck(${f.id})"><i class="fa-solid fa-check"></i> J√° respondeu?</button>`; break;
        case 'RESPONDIDO': actionBtn = `<button class="btn btn-sm btn-warning" onclick="App.actionSendApproval(${f.id})"><i class="fa-solid fa-paper-plane"></i> Enviar p/ Aprova√ß√£o</button>`; break;
        case 'APROVACAO': actionBtn = `<button class="btn btn-sm btn-success" onclick="App.actionApprove(${f.id})"><i class="fa-solid fa-thumbs-up"></i> Aprovar</button>`; break;
        case 'FINALIZADO': actionBtn = `<span style="color:#10b981; font-size:0.8rem"><i class="fa-solid fa-check-circle"></i> Conclu√≠do</span>`; break;
      }
      
      const row = `<tr class="animate__animated animate__fadeIn"><td><div style="font-weight:600">${f.clientName}</div><div style="font-size:0.75rem; color:#64748b">${f.clientPhone}</div></td><td><a href="${f.link}" target="_blank" style="color:var(--primary); text-decoration:none; font-weight:500"><i class="fa-solid fa-external-link-alt"></i> Abrir Forms</a></td><td><span class="badge ${stConfig.class}"><div class="badge-dot"></div> ${stConfig.label}</span></td><td>${actionBtn}</td><td><button class="btn btn-sm btn-outline" style="color:var(--danger)" onclick="App.deleteForm(${f.id})" title="Excluir"><i class="fa-solid fa-trash"></i></button></td></tr>`;
      tbody.innerHTML += row;
    });
    
    this.animateValue("kpiPending", kpi.pending);
    this.animateValue("kpiSent", kpi.sent);
    this.animateValue("kpiProject", kpi.project);
    this.animateValue("kpiDone", kpi.done);
  },
  
  openWhats(phone, text) { window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank'); },
  
  toast(title, icon = 'success') {
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true, didOpen: (toast) => { toast.onmouseenter = Swal.stopTimer; toast.onmouseleave = Swal.resumeTimer; } });
    Toast.fire({ icon: icon, title: title });
  },
  
  animateValue(id, value) { const el = document.getElementById(id); if(el) el.textContent = value; }
};
</script>

<script>

(function () {

    const SYNC_TABLE = 'lg_crm_supadb';
    const CANONICAL_DB = 'lg_crmDB';
  
    let storedId = sessionStorage.getItem('sync_device_id');
    if (!storedId) {
        storedId = crypto.randomUUID();
        sessionStorage.setItem('sync_device_id', storedId);
    }
    const DEVICE_ID = storedId;
    
    let isReplicating = false; 
    let syncInterval = null;

  
    const syncCache = new Map();

    const getClient = () => window.supabaseClient || window.supabase;

    const waitForSupabase = () => new Promise(resolve => {
        const check = () => getClient() ? resolve(getClient()) : setTimeout(check, 100);
        check();
    });

    async function getUserId() {
        const client = await waitForSupabase();
        const { data } = await client.auth.getSession();
        return data?.session?.user?.id || null;
    }

    function generateSignature(value) {
        // Garante que null/undefined sejam tratados iguais
        if (value === null || value === undefined) return 'null';
        return JSON.stringify(value);
    }

    const original = {
        put: IDBObjectStore.prototype.put,
        add: IDBObjectStore.prototype.add,
        delete: IDBObjectStore.prototype.delete
    };

    async function scheduleRealtimeUpload(storeName, method, key, value) {
        if (isReplicating) return; 

        const client = getClient();
        const userId = await getUserId();
        if (!client || !userId) return;

        const cacheKey = `${storeName}-${key}`;
        
        // Atualiza cache local imediatamente
        if (method === 'delete') {
            syncCache.delete(cacheKey);
        } else {
            syncCache.set(cacheKey, generateSignature(value));
        }

        client.from(SYNC_TABLE).upsert({
            user_id: userId,
            db_name: CANONICAL_DB,
            store_name: storeName,
            record_key: String(key),
            record_value: method === 'delete' ? null : value,
            is_deleted: method === 'delete',
            device_id: DEVICE_ID,
            updated_at: new Date().toISOString()
        }, { onConflict: 'user_id,db_name,store_name,record_key' })
        .then(({ error }) => {
            if (error) console.warn(`‚ö†Ô∏è Sync Upload Falhou:`, error.message);
        });
    }

    IDBObjectStore.prototype.put = function (v, k) {
        const req = original.put.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'put', k || e.target.result, v);
        return req;
    };

    IDBObjectStore.prototype.add = function (v, k) {
        const req = original.add.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'add', k || e.target.result, v);
        return req;
    };

    IDBObjectStore.prototype.delete = function (k) {
        const req = original.delete.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'delete', k, null);
        return req;
    };

    console.log(' .)');

    async function smartUploadLoop() {
        const userId = await getUserId();
        const client = getClient();
        if (!userId || !client) return;

        const req = indexedDB.open(CANONICAL_DB);
        
        req.onsuccess = (e) => {
            const db = e.target.result;
            const storeNames = Array.from(db.objectStoreNames);

            storeNames.forEach(storeName => {
                const tx = db.transaction([storeName], 'readonly');
                const store = tx.objectStore(storeName);
                
                Promise.all([
                    new Promise(r => store.getAll().onsuccess = (ev) => r(ev.target.result)),
                    new Promise(r => store.getAllKeys().onsuccess = (ev) => r(ev.target.result))
                ]).then(async ([records, keys]) => {
                    if (!records.length) return;

                    const changedRecords = [];

                    records.forEach((item, index) => {
                        const key = String(keys[index]);
                        const cacheKey = `${storeName}-${key}`;
                        const currentSig = generateSignature(item);

                       
                        if (syncCache.get(cacheKey) !== currentSig) {
                            changedRecords.push({
                                user_id: userId,
                                db_name: CANONICAL_DB,
                                store_name: storeName,
                                record_key: key,
                                record_value: item,
                                is_deleted: false,
                                device_id: DEVICE_ID,
                                updated_at: new Date().toISOString()
                            });
                            syncCache.set(cacheKey, currentSig);
                        }
                    });

                    if (changedRecords.length > 0) {
                        console.log(`.: ${changedRecords.length} itens`);
                        await client.from(SYNC_TABLE).upsert(changedRecords, { 
                            onConflict: 'user_id,db_name,store_name,record_key' 
                        });
                    }
                });
            });
        };
    }

    async function smartDownloadLoop() {
        const userId = await getUserId();
        const client = getClient();
        if (!userId || !client) return;

        const { data, error } = await client
            .from(SYNC_TABLE)
            .select('*')
            .eq('user_id', userId)
            .eq('db_name', CANONICAL_DB);

        if (error || !data || !data.length) return;

        const req = indexedDB.open(CANONICAL_DB);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const localStores = Array.from(db.objectStoreNames);
            
            const validRecords = data.filter(r => localStores.includes(r.store_name));
            if (!validRecords.length) return;

            const tx = db.transaction([...new Set(validRecords.map(r => r.store_name))], 'readwrite');
            isReplicating = true;

            let writes = 0;

            validRecords.forEach(r => {
               
                if (r.device_id === DEVICE_ID) return;

                const store = tx.objectStore(r.store_name);
               
                const key = !isNaN(r.record_key) ? Number(r.record_key) : r.record_key;
                const cacheKey = `${r.store_name}-${r.record_key}`;
                
                
                if (r.is_deleted) {
                   
                    store.delete(key);
                    
                    if (syncCache.has(cacheKey)) {
                        syncCache.delete(cacheKey);
                        writes++;
                    }
                    return;
                }

                
                const incomingSig = generateSignature(r.record_value);
                const localSig = syncCache.get(cacheKey);

                if (incomingSig === localSig) {
                    return; 
                }

                
                const val = r.record_value;
                if (store.keyPath && val && typeof val === 'object') {
                    // Se a store usa keyPath inline, injetamos a chave se necess√°rio
                    if (!val[store.keyPath]) val[store.keyPath] = key;
                    store.put(val);
                } else {
                    store.put(val, key);
                }
                
                syncCache.set(cacheKey, incomingSig);
                writes++;
            });

            tx.oncomplete = () => {
                isReplicating = false;
                if (writes > 0) console.log(`üì• Download Sync: ${writes} altera√ß√µes aplicadas.`);
            };
            
            tx.onerror = () => isReplicating = false;
        };
    }

       async function startService() {
        const userId = await getUserId();
        if (!userId) return;

        console.log('. ', userId);
        const client = getClient();

        client.channel('global-sync-live')
            .on('postgres_changes', { 
                event: '*', schema: 'public', table: SYNC_TABLE, filter: `user_id=eq.${userId}` 
            }, payload => {
                // S√≥ dispara download se o evento veio de OUTRO device
                if (payload.new && payload.new.device_id !== DEVICE_ID) {
                    smartDownloadLoop();
                }
            })
            .subscribe();

      
        await smartUploadLoop(); 
        setTimeout(smartDownloadLoop, 500); // Pequeno delay para garantir que o Upload populou o cache

        if (syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(async () => {
            await smartUploadLoop();
            await smartDownloadLoop();
        }, 10000);
    }

    waitForSupabase().then(client => {
        client.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) startService();
        });
        getUserId().then(id => { if (id) startService(); });
    });

})();
</script>
</body>
</html>
